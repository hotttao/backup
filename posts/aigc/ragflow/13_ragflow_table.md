---
weight: 1
title: "RagFlow ä¸­çš„è¡¨"
date: 2025-08-20T10:00:00+08:00
lastmod: 2025-08-20T10:00:00+08:00
draft: false
author: "å®‹æ¶›"
authorLink: "https://hotttao.github.io/"
description: "RagFlow ä¸­çš„è¡¨"
featuredImage: 

tags: ["RagFlow"]
categories: ["langchain"]

lightgallery: true

toc:
  auto: false
---

åœ¨æ·±å…¥åˆ°å…·ä½“ä¸šåŠ¡ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ ragflow éƒ½å®šä¹‰äº†å“ªäº›è¡¨ã€‚

## 1. Ragflow å®šä¹‰çš„è¡¨
Ragflow å®šä¹‰äº†ä»¥ä¸‹è¡¨ï¼Œè¿™äº›è¡¨ä½äº `api\db\db_models.py`

| è¡¨å | ä¸»è¦å­—æ®µ/å…³è” | ä½œç”¨è¯´æ˜ |
|---|---|---|
| user | `id,email,language,timezone` | ç”¨æˆ·è´¦å·ä¿¡æ¯ä¸ç™»å½•å±æ€§ |
| tenant | `id,llm_id,embd_id,asr_id,img2txt_id,rerank_id` | ç§Ÿæˆ·/å·¥ä½œåŒºï¼Œé»˜è®¤æ¨¡å‹ä¸é¢åº¦é…ç½® |
| user_tenant | `user_id,tenant_id,role` | ç”¨æˆ·ä¸ç§Ÿæˆ·çš„å…³ç³»ä¸è§’è‰² |
| invitation_code | `code,user_id,tenant_id` | é‚€è¯·ç ä¸å—é‚€è®°å½• |
| llm_factories | `name,tags,logo` | æ¨¡å‹å‚å•†ç›®å½• |
| llm | å¤åˆä¸»é”®(`fid,llm_name`), `model_type,tags,is_tools` | å‚å•†ä¸‹å…·ä½“æ¨¡å‹æ¸…å•ä¸èƒ½åŠ›æ ‡ç­¾ |
| tenant_llm | å¤åˆä¸»é”®(`tenant_id,llm_factory,llm_name`), `api_key,api_base,max_tokens` | ç§Ÿæˆ·ç»‘å®šçš„å…·ä½“æ¨¡å‹é…ç½®ï¼ˆåŒ…å« API Keyã€Base URLã€é¢åº¦ç­‰ï¼‰ |
| tenant_langfuse | `tenant_id,host,public_key,secret_key` | ç§Ÿæˆ·çš„ Langfuse è§‚æµ‹é…ç½® |
| knowledgebase | `id,tenant_id,language,embd_id,parser_id,parser_config,pagerank` | çŸ¥è¯†åº“å…ƒæ•°æ®ä¸é»˜è®¤è§£æ/æ£€ç´¢å‚æ•° |
| document | `id,kb_id,parser_id,parser_config,name,location,size,progress` | æ–‡æ¡£å…ƒæ•°æ®ã€è§£æè¿›åº¦ä¸ç»Ÿè®¡ |
| file | `id,parent_id,tenant_id,name,location,size,type` | æ–‡ä»¶/æ–‡ä»¶å¤¹å…ƒä¿¡æ¯ï¼ˆèµ„æºç®¡ç†ï¼‰ |
| file2document | `file_id,document_id` | æ–‡ä»¶ä¸æ–‡æ¡£æ˜ å°„å…³ç³» |
| task | `id,doc_id,from_page,to_page,progress,retry_count,digest,chunk_ids` | æ–‡æ¡£è§£æä»»åŠ¡ä¸è¿›åº¦ã€é‡è¯•å’Œäº§ç‰© |
| dialog | `id,tenant_id,llm_id,rerank_id,prompt_config,llm_setting,top_k,kb_ids` | å¯¹è¯åº”ç”¨é…ç½®ï¼ˆæ£€ç´¢+ç”Ÿæˆï¼‰ |
| conversation | `id,dialog_id,user_id,message,reference` | æŸå¯¹è¯åº”ç”¨ä¸‹çš„ä¼šè¯ä¸æ¶ˆæ¯æ‘˜è¦ |
| api_token | å¤åˆä¸»é”®(`tenant_id,token`), `dialog_id,source,beta` | API è®¿é—®ä»¤ç‰Œï¼ˆå¯ç»‘å®šåº”ç”¨/æ¥æºï¼‰ |
| api_4_conversation | `id,dialog_id,user_id,tokens,duration,round,errors,source` | API è°ƒç”¨äº§ç”Ÿçš„ä¼šè¯ä¸ç”¨é‡/é”™è¯¯æ—¥å¿— |
| user_canvas | `id,user_id,title,permission,dsl` | ç”¨æˆ·ç”»å¸ƒï¼ˆç¼–æ’/å·¥ä½œæµï¼‰å®ä¾‹ |
| canvas_template | `id,title,canvas_type,dsl` | ç”»å¸ƒæ¨¡æ¿åº“ |
| user_canvas_version | `id,user_canvas_id,title,description,dsl` | ç”»å¸ƒç‰ˆæœ¬å†å² |
| mcp_server | `id,tenant_id,name,url,server_type,headers,variables` | MCP Server æ³¨å†Œä¸è°ƒç”¨é…ç½® |
| search | `id,tenant_id,name,search_config` | ç‹¬ç«‹æœç´¢é…ç½®ï¼ˆè·¨ KB/Docã€æ£€ç´¢/é‡æ’/é«˜äº®ç­‰ï¼‰ |

æŒ‰ç…§ç›¸å…³æ€§ï¼Œè¿™äº›è¡¨å¯ä»¥åˆ†ä¸º:

### 1.1 ç”¨æˆ·ä¸æƒé™ç®¡ç†

| è¡¨å | ä½œç”¨ |
|---|---|
| `user` | ç”¨æˆ·è´¦å·ä¿¡æ¯ä¸ç™»å½•å±æ€§ |
| `tenant` | ç§Ÿæˆ·/å·¥ä½œåŒºï¼Œé»˜è®¤æ¨¡å‹ä¸é¢åº¦é…ç½® |
| `user_tenant` | ç”¨æˆ·ä¸ç§Ÿæˆ·çš„å…³ç³»ä¸è§’è‰² |
| `invitation_code` | é‚€è¯·ç ä¸å—é‚€è®°å½• |

### 1.2 æ¨¡å‹ä¸AIèƒ½åŠ›ç®¡ç†
| è¡¨å | ä½œç”¨ |
|---|---|
| `llm_factories` | æ¨¡å‹å‚å•†ç›®å½• |
| `llm` | å‚å•†ä¸‹å…·ä½“æ¨¡å‹æ¸…å•ä¸èƒ½åŠ›æ ‡ç­¾ |
| `tenant_llm` | ç§Ÿæˆ·æ¥å…¥è‡ªå®šä¹‰æ¨¡å‹ä¸é…é¢ |
| `tenant_langfuse` | ç§Ÿæˆ·çš„ Langfuse è§‚æµ‹é…ç½® |

### 1.3 çŸ¥è¯†åº“ä¸æ–‡æ¡£ç®¡ç†
| è¡¨å | ä½œç”¨ |
|---|---|
| `knowledgebase` | çŸ¥è¯†åº“å…ƒæ•°æ®ä¸é»˜è®¤è§£æ/æ£€ç´¢å‚æ•° |
| `document` | æ–‡æ¡£å…ƒæ•°æ®ã€è§£æè¿›åº¦ä¸ç»Ÿè®¡ |
| `file` | æ–‡ä»¶/æ–‡ä»¶å¤¹å…ƒä¿¡æ¯ï¼ˆèµ„æºç®¡ç†ï¼‰ |
| `file2document` | æ–‡ä»¶ä¸æ–‡æ¡£æ˜ å°„å…³ç³» |
| `task` | æ–‡æ¡£è§£æä»»åŠ¡ä¸è¿›åº¦ã€é‡è¯•å’Œäº§ç‰© |

### 1.4 å¯¹è¯ä¸æ£€ç´¢åº”ç”¨
| è¡¨å | ä½œç”¨ |
|---|---|
| `dialog` | å¯¹è¯åº”ç”¨é…ç½®ï¼ˆæ£€ç´¢+ç”Ÿæˆï¼‰ |
| `conversation` | æŸå¯¹è¯åº”ç”¨ä¸‹çš„ä¼šè¯ä¸æ¶ˆæ¯æ‘˜è¦ |
| `search` | ç‹¬ç«‹æœç´¢é…ç½®ï¼ˆè·¨ KB/Docã€æ£€ç´¢/é‡æ’/é«˜äº®ç­‰ï¼‰ |

### 1.5 APIä¸é›†æˆç®¡ç†
| è¡¨å | ä½œç”¨ |
|---|---|
| `api_token` | API è®¿é—®ä»¤ç‰Œï¼ˆå¯ç»‘å®šåº”ç”¨/æ¥æºï¼‰ |
| `api_4_conversation` | API è°ƒç”¨äº§ç”Ÿçš„ä¼šè¯ä¸ç”¨é‡/é”™è¯¯æ—¥å¿— |
| `mcp_server` | MCP Server æ³¨å†Œä¸è°ƒç”¨é…ç½® |

### 1.6 å·¥ä½œæµä¸ç¼–æ’
| è¡¨å | ä½œç”¨ |
|---|---|
| `user_canvas` | ç”¨æˆ·ç”»å¸ƒï¼ˆç¼–æ’/å·¥ä½œæµï¼‰å®ä¾‹ |
| `canvas_template` | ç”»å¸ƒæ¨¡æ¿åº“ |
| `user_canvas_version` | ç”»å¸ƒç‰ˆæœ¬å†å² |

### 1.7 æ ¸å¿ƒä¸šåŠ¡æµç¨‹
- **ç”¨æˆ·ç®¡ç†** â†’ **æ¨¡å‹é…ç½®** â†’ **çŸ¥è¯†åº“æ„å»º** â†’ **åº”ç”¨åˆ›å»º** â†’ **APIè°ƒç”¨**
- **æ–‡æ¡£ä¸Šä¼ ** â†’ **ä»»åŠ¡è§£æ** â†’ **å‘é‡åŒ–å­˜å‚¨** â†’ **æ£€ç´¢å¯¹è¯** â†’ **å·¥ä½œæµç¼–æ’**

## 2. çŸ¥è¯†åº“ä¸æ–‡æ¡£ç®¡ç†
| è¡¨å | ä½œç”¨ |
|---|---|
| `knowledgebase` | çŸ¥è¯†åº“å…ƒæ•°æ®ä¸é»˜è®¤è§£æ/æ£€ç´¢å‚æ•° |
| `document` | æ–‡æ¡£å…ƒæ•°æ®ã€è§£æè¿›åº¦ä¸ç»Ÿè®¡ |
| `file` | æ–‡ä»¶/æ–‡ä»¶å¤¹å…ƒä¿¡æ¯ï¼ˆèµ„æºç®¡ç†ï¼‰ |
| `file2document` | æ–‡ä»¶ä¸æ–‡æ¡£æ˜ å°„å…³ç³» |
| `task` | æ–‡æ¡£è§£æä»»åŠ¡ä¸è¿›åº¦ã€é‡è¯•å’Œäº§ç‰© |

### 2.1 å±‚çº§å…³ç³»
çŸ¥è¯†åº“ä¸æ–‡æ¡£ç®¡ç†æœ‰ä¸‰ä¸ªè¡¨: `knowledgebase`ã€`document`ã€`file`ã€‚å®ƒä»¬å…¶å®æ˜¯ä¸‰å±‚ç»„ç»‡å…³ç³»ï¼Œä»å¤§åˆ°å°é€çº§åŒ…å«ï¼š

---

#### **KnowledgeBase (çŸ¥è¯†åº“)**

* **æœ€é¡¶å±‚çš„é€»è¾‘å®¹å™¨**ï¼Œä»£è¡¨ä¸€ä¸ªå®Œæ•´çš„çŸ¥è¯†é›†åˆã€‚
* æ¯ä¸ª KnowledgeBase å¯¹åº”ä¸€ä¸ªä¸»é¢˜æˆ–åº”ç”¨åœºæ™¯ï¼ˆä¾‹å¦‚â€œæ³•å¾‹æ³•è§„åº“â€â€œäº§å“æ‰‹å†Œåº“â€ï¼‰ã€‚
* **é‡Œé¢åŒ…å«å¤šä¸ª Document**ï¼Œæ˜¯å¯¹çŸ¥è¯†çš„é€»è¾‘åˆ†ç»„ã€‚
* åœ¨ RAG æ£€ç´¢æ—¶ï¼Œç”¨æˆ·é€šå¸¸æ˜¯æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ªçŸ¥è¯†åº“è¿›è¡Œæ£€ç´¢ã€‚

---

#### **Document (æ–‡æ¡£)**

* **çŸ¥è¯†åº“ä¸­çš„ä¸€ä¸ªæ¡ç›®**ï¼Œé€»è¾‘ä¸Šè¡¨ç¤ºä¸€ä»½â€œæ–‡æ¡£â€ã€‚
* ä¸€ä¸ª Document å¯èƒ½æ˜¯ç”¨æˆ·ä¸Šä¼ çš„ä¸€ä»½ PDF/Wordï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªç½‘é¡µçˆ¬å–çš„ç»“æœã€‚
* **Document ä¸ File æ˜¯ä¸€å¯¹å¤šå…³ç³»**ï¼š

  * ä¸€ä¸ª Document å¯ä»¥ç”±å¤šä¸ª File ç»„æˆï¼ˆä¾‹å¦‚ä¸€æœ¬ä¹¦çš„å¤šç« ã€ä¸€ä¸ªé•¿ PDF è¢«æ‹†åˆ†æˆå¤šä¸ªæ–‡ä»¶å­˜å‚¨ï¼‰ã€‚
* åœ¨ RAG å¤„ç†æ—¶ï¼ŒDocument ä¼šè¢«è§£æã€åˆ†ç‰‡ï¼ˆchunkï¼‰ï¼Œç„¶åå­˜å…¥å‘é‡æ•°æ®åº“ä¸­ã€‚
* åœ¨ UI ä¸Šä½ çœ‹åˆ°çš„â€œæŸç¯‡æ–‡æ¡£â€ï¼Œå¯¹åº”çš„å°±æ˜¯ Documentã€‚

---

#### **File (æ–‡ä»¶)**


* **æœ€åº•å±‚çš„ç‰©ç†æ–‡ä»¶å®ä½“**ï¼Œå³ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ï¼Œæˆ–è€… RAGFlow çˆ¬å–/åŒæ­¥ä¸‹æ¥çš„åŸå§‹æ–‡ä»¶ã€‚
* File æ˜¯ **åŸå§‹è¾“å…¥æ•°æ®**ï¼ŒDocument æ˜¯å®ƒçš„é€»è¾‘è¡¨ç¤ºã€‚
* æ–‡ä»¶å¯èƒ½æ˜¯ï¼š

  * æœ¬åœ°ä¸Šä¼ çš„ PDFã€TXTã€DOCXã€Markdown
  * çˆ¬å–ä¸‹æ¥çš„ HTML
  * ç”šè‡³æ˜¯æ•°æ®åº“å¯¼å‡ºçš„ CSV
* ç³»ç»Ÿä¼šå¯¹ File åšè§£æï¼ˆparser â†’ chunk â†’ embeddingï¼‰ï¼Œå†æŒ‚è½½åˆ°å¯¹åº”çš„ Documentã€‚

### 2.2 KnowledgeBase

| å­—æ®µå                            | ç±»å‹                    | å«ä¹‰                                                  |
| ------------------------------ | --------------------- | --------------------------------------------------- |
| **id**                         | CharField(32), PK     | çŸ¥è¯†åº“ IDï¼Œä¸»é”®ï¼Œé€šå¸¸æ˜¯ UUID                                  |
| **avatar**                     | TextField             | çŸ¥è¯†åº“çš„å¤´åƒï¼ˆbase64 ç¼–ç å­˜å‚¨å›¾ç‰‡ï¼‰                               |
| **tenant_id**                 | CharField(32), index  | ç§Ÿæˆ· IDï¼Œå¤šç§Ÿæˆ·åœºæ™¯ä¸‹ç”¨æ¥åŒºåˆ†ä¸åŒç”¨æˆ·/ç»„ç»‡çš„æ•°æ®                          |
| **name**                       | CharField(128), index | çŸ¥è¯†åº“åç§°                                               |
| **language**                   | CharField(32), index  | çŸ¥è¯†åº“è¯­è¨€ï¼Œé»˜è®¤æ ¹æ®ç³»ç»Ÿè¯­è¨€ç¯å¢ƒè®¾ç½®ï¼ˆ"English" æˆ– "Chinese"ï¼‰           |
| **description**                | TextField             | çŸ¥è¯†åº“æè¿°                                               |
| **embd_id**                   | CharField(128), index | é»˜è®¤çš„å‘é‡åŒ–æ¨¡å‹ IDï¼ˆembedding model IDï¼‰ï¼Œå†³å®šæ–‡æ¡£åˆ‡åˆ†åç”¨å“ªä¸ªæ¨¡å‹è½¬å‘é‡     |
| **permission**                 | CharField(16), index  | æƒé™èŒƒå›´ï¼Œ`me`ï¼ˆä¸ªäººå¯è§ï¼‰æˆ– `team`ï¼ˆå›¢é˜Ÿå¯è§ï¼‰                       |
| **created_by**                | CharField(32), index  | åˆ›å»ºè€… ID                                              |
| **doc_num**                   | IntegerField, index   | çŸ¥è¯†åº“ä¸‹çš„æ–‡æ¡£æ•°é‡                                           |
| **token_num**                 | IntegerField, index   | çŸ¥è¯†åº“ä¸‹çš„ token æ€»æ•°ï¼ˆç”¨äºæ§åˆ¶ç”¨é‡æˆ–è®¡è´¹ï¼‰                           |
| **chunk_num**                 | IntegerField, index   | çŸ¥è¯†åº“ä¸‹çš„åˆ‡ç‰‡ï¼ˆchunkï¼‰æ•°é‡                                    |
| **similarity_threshold**      | FloatField, index     | è¯­ä¹‰æ£€ç´¢æ—¶çš„ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆä½äºè¯¥é˜ˆå€¼çš„ç»“æœä¸ä¼šè¿”å›ï¼‰ï¼Œé»˜è®¤ 0.2                    |
| **vector_similarity_weight** | FloatField, index     | å¬å›æ—¶å‘é‡ç›¸ä¼¼åº¦çš„æƒé‡ï¼Œç”¨äºä¸å…¶ä»–æƒé‡ï¼ˆå¦‚å…³é”®è¯æ£€ç´¢ï¼‰æ··åˆè®¡ç®—ï¼Œé»˜è®¤ 0.3              |
| **parser_id**                 | CharField(32), index  | é»˜è®¤æ–‡æ¡£è§£æå™¨ IDï¼Œå†³å®šä¸Šä¼ æ–‡ä»¶æ—¶ç”¨ä»€ä¹ˆ parserï¼ˆå¦‚ naiveã€pdf_parser ç­‰ï¼‰ |
| **parser_config**             | JSONField             | è§£æå™¨é…ç½®ï¼Œé»˜è®¤ `{ "pages": [[1, 1000000]] }`ï¼Œè¡¨ç¤ºè§£ææ‰€æœ‰é¡µ      |
| **pagerank**                   | IntegerField          | çŸ¥è¯†åº“æ’åºæƒé‡ï¼ˆæ¯”å¦‚åœ¨ UI ä¸­æ’åºå±•ç¤ºæ—¶ä½¿ç”¨ï¼‰                            |
| **status**                     | CharField(1), index   | çŸ¥è¯†åº“çŠ¶æ€ï¼Œ`0=æ— æ•ˆ`ï¼Œ`1=æœ‰æ•ˆ`ï¼Œé»˜è®¤ 1                            |

---

âœ… ç®€å•æ€»ç»“ï¼š
`knowledgebase` è¡¨æ˜¯ RagFlow çš„ **é¡¶å±‚ä¸šåŠ¡å®ä½“**ï¼Œ
ä¸»è¦å­˜å‚¨ **çŸ¥è¯†åº“çš„åŸºæœ¬ä¿¡æ¯ï¼ˆidã€nameã€descã€avatarã€tenant_idï¼‰**ï¼Œ
**è¿è¡Œé…ç½®ï¼ˆembd_idã€parser_idã€similarity_thresholdï¼‰**ï¼Œ
ä»¥åŠ **ç»Ÿè®¡ä¿¡æ¯ï¼ˆdoc_numã€token_numã€chunk_numï¼‰**ã€‚

### 2.3 Document

| å­—æ®µå                    | ç±»å‹                    | å«ä¹‰                                                            |
| ---------------------- | --------------------- | ------------------------------------------------------------- |
| **id**                 | CharField(32), PK     | æ–‡æ¡£ IDï¼ˆä¸»é”®ï¼Œé€šå¸¸æ˜¯ UUIDï¼‰                                            |
| **thumbnail**          | TextField             | æ–‡æ¡£çš„ç¼©ç•¥å›¾ï¼ˆbase64 å­˜å‚¨çš„å›¾ç‰‡ï¼‰ï¼Œç”¨äºå‰ç«¯é¢„è§ˆ                                   |
| **kb_id**             | CharField(256), index | æ‰€å±çŸ¥è¯†åº“ IDï¼ˆå¯¹åº” `knowledgebase.id`ï¼Œå¤–é”®å…³ç³»ï¼‰                          |
| **parser_id**         | CharField(32), index  | æ–‡æ¡£è§£æå™¨ IDï¼ˆå†³å®šå¦‚ä½•è§£ææ–‡æ¡£ï¼Œå¦‚ pdf_parserã€docx_parser ç­‰ï¼‰               |
| **parser_config**     | JSONField             | è§£æå™¨é…ç½®ï¼Œé»˜è®¤ `{ "pages": [[1, 1000000]] }`ï¼Œè¡¨ç¤ºè§£æå…¨éƒ¨é¡µ                |
| **source_type**       | CharField(128), index | æ–‡æ¡£æ¥æºï¼Œé»˜è®¤ `"local"`ï¼Œä¹Ÿå¯ä»¥æ˜¯ `"url"`, `"s3"` ç­‰                      |
| **type**               | CharField(32), index  | æ–‡ä»¶ç±»å‹ï¼ˆæ‰©å±•åï¼Œå¦‚ `pdf`ã€`docx`ï¼‰                                      |
| **created_by**        | CharField(32), index  | ä¸Šä¼ æ–‡æ¡£çš„ç”¨æˆ· ID                                                    |
| **name**               | CharField(255), index | æ–‡ä»¶åç§°                                                          |
| **location**           | CharField(255), index | æ–‡ä»¶å­˜å‚¨è·¯å¾„ï¼ˆå¯èƒ½æ˜¯æœ¬åœ°è·¯å¾„æˆ–è¿œç¨‹å­˜å‚¨åœ°å€ï¼‰                                        |
| **size**               | IntegerField, index   | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚æ•°ï¼‰                                                     |
| **token_num**         | IntegerField, index   | æ–‡æ¡£è§£æååˆ‡åˆ†å‡ºçš„ Token æ•°é‡                                            |
| **chunk_num**         | IntegerField, index   | æ–‡æ¡£åˆ‡åˆ†åçš„ chunk æ•°é‡                                               |
| **progress**           | FloatField, index     | æ–‡æ¡£è§£æè¿›åº¦ï¼ˆ0 \~ 1 ä¹‹é—´ï¼‰                                             |
| **progress_msg**      | TextField             | è§£æè¿‡ç¨‹ä¸­çš„çŠ¶æ€ä¿¡æ¯ï¼ˆæ—¥å¿—/é”™è¯¯ä¿¡æ¯ç­‰ï¼‰ï¼Œé»˜è®¤ç©ºå­—ç¬¦ä¸²                                   |
| **process_begin_at** | DateTimeField, index  | æ–‡æ¡£è§£æå¼€å§‹æ—¶é—´                                                      |
| **process_duration**  | FloatField            | æ–‡æ¡£è§£æè€—æ—¶ï¼ˆç§’ï¼‰                                                     |
| **meta_fields**       | JSONField             | è‡ªå®šä¹‰å…ƒä¿¡æ¯ï¼Œé»˜è®¤ `{}`ï¼Œå¯å­˜æ”¾é¢å¤–å­—æ®µ                                        |
| **suffix**             | CharField(32), index  | æ–‡ä»¶çš„çœŸå®åç¼€åï¼ˆä¾‹å¦‚ `.tar.gz` çš„æƒ…å†µï¼Œ`type` å¯èƒ½æ˜¯ `gz`ï¼Œè€Œ `suffix` ä¼šè®°å½•å®Œæ•´ä¿¡æ¯ï¼‰ |
| **run**                | CharField(1), index   | æ–‡æ¡£æ˜¯å¦æ­£åœ¨å¤„ç†ï¼š`1=è¿è¡Œ`ï¼Œ`2=å–æ¶ˆ`ï¼Œ`0=é»˜è®¤`                                 |
| **status**             | CharField(1), index   | æ–‡æ¡£æ˜¯å¦æœ‰æ•ˆï¼š`0=æ— æ•ˆ`ï¼Œ`1=æœ‰æ•ˆ`ï¼Œé»˜è®¤ `1`                                   |

---

âœ… æ€»ç»“ï¼š

* `document` è¡¨æ˜¯ RagFlow ä¸­ **çŸ¥è¯†åº“ä¸‹çš„å…·ä½“æ–‡æ¡£è®°å½•**ã€‚
* å®ƒå­˜å‚¨äº†æ–‡æ¡£çš„ **åŸºæœ¬ä¿¡æ¯ï¼ˆidã€ã€nametypeã€sizeã€locationï¼‰**ï¼Œ
  **è§£æé…ç½®ï¼ˆparser_idã€parser_configï¼‰**ï¼Œ
  **ç»Ÿè®¡æŒ‡æ ‡ï¼ˆtoken_numã€chunk_numã€progressï¼‰**ï¼Œ
  **çŠ¶æ€æ§åˆ¶ï¼ˆrunã€statusï¼‰**ã€‚
* å®ƒä¸ `knowledgebase` è¡¨é€šè¿‡ `kb_id` å…³è”ï¼Œå’Œ **æ–‡ä»¶å­˜å‚¨è¡¨(file)** æœ‰ä¸‹æ¸¸å…³ç³»ã€‚


### 2.4 File

| å­—æ®µå              | ç±»å‹                    | å«ä¹‰                                        |
| ---------------- | --------------------- | ----------------------------------------- |
| **id**           | CharField(32), PK     | æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹çš„å”¯ä¸€ IDï¼ˆé€šå¸¸æ˜¯ UUIDï¼‰                    |
| **parent_id**   | CharField(32), index  | çˆ¶ç›®å½• IDï¼ˆå¦‚æœæ˜¯æ ¹ç›®å½•åˆ™å¯èƒ½ä¸ºç‰¹å®šå€¼ï¼Œå¦‚ `"0"`ï¼‰ï¼Œç”¨äºç»„ç»‡æ–‡ä»¶æ ‘ç»“æ„   |
| **tenant_id**   | CharField(32), index  | ç§Ÿæˆ· IDï¼ˆåŒºåˆ†å¤šç§Ÿæˆ·ç¯å¢ƒä¸‹çš„æ•°æ®éš”ç¦»ï¼‰                      |
| **created_by**  | CharField(32), index  | æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹çš„åˆ›å»ºè€…ï¼ˆç”¨æˆ· IDï¼‰                         |
| **name**         | CharField(255), index | æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹åç§°                                  |
| **location**     | CharField(255), index | æ–‡ä»¶å­˜å‚¨è·¯å¾„ï¼ˆç‰©ç†è·¯å¾„æˆ–è¿œç¨‹å­˜å‚¨åœ°å€ï¼‰                       |
| **size**         | IntegerField, index   | æ–‡ä»¶å¤§å°ï¼ˆå•ä½å­—èŠ‚ï¼‰ï¼Œæ–‡ä»¶å¤¹åˆ™å¯èƒ½ä¸º 0                      |
| **type**         | CharField(32), index  | æ–‡ä»¶æ‰©å±•åï¼ˆä¾‹å¦‚ `pdf`, `docx`ï¼Œæ–‡ä»¶å¤¹å¯èƒ½ç‰¹æ®Šæ ‡è®°ï¼‰         |
| **source_type** | CharField(128), index | æ–‡ä»¶æ¥æºï¼ˆå¦‚ `"local"`ã€`"s3"`ã€`"url"` ç­‰ï¼‰ï¼Œé»˜è®¤ç©ºå­—ç¬¦ä¸² |

---

âœ… æ€»ç»“

* `file` è¡¨ç”¨æ¥ç®¡ç† **æ–‡ä»¶ç³»ç»Ÿå±‚é¢çš„èµ„æº**ï¼Œæ—¢å¯ä»¥è¡¨ç¤ºæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºç›®å½•ï¼ˆé€šè¿‡ `parent_id` å½¢æˆæ ‘å½¢ç»“æ„ï¼‰ã€‚
* ä¸ `document` è¡¨çš„åŒºåˆ«ï¼š

  * `file` æ˜¯ **å­˜å‚¨å±‚**ï¼Œå…³å¿ƒçš„æ˜¯ç›®å½•/æ–‡ä»¶çš„å±‚æ¬¡ã€æ¥æºã€ä½ç½®ã€‚
  * `document` æ˜¯ **çŸ¥è¯†åº“è§£æå±‚**ï¼Œå…³å¿ƒçš„æ˜¯æ–‡ä»¶çš„å†…å®¹è§£æã€åˆ‡åˆ†ã€token ç»Ÿè®¡ç­‰ã€‚
* åœ¨ä¸šåŠ¡æµç¨‹ä¸­ï¼š

  1. ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ â†’ å­˜å‚¨åœ¨ `file` è¡¨ä¸­ï¼ˆå¸¦è·¯å¾„ã€å¤§å°ã€æ¥æºï¼‰ã€‚
  2. é€‰æ‹©æ–‡ä»¶å¹¶å¯¼å…¥çŸ¥è¯†åº“ â†’ åœ¨ `document` è¡¨ä¸­ç”Ÿæˆä¸€æ¡è®°å½•ï¼Œç”¨äºè§£æå¤„ç†ã€‚
  3. æ–‡æ¡£è§£æ â†’ ç”Ÿæˆ `chunk`ï¼ˆåˆ‡åˆ†æ–‡æœ¬ï¼‰å¹¶å†™å…¥å‘é‡åº“ã€‚


### 2.5 Task

| å­—æ®µå                   | ç±»å‹                   | å«ä¹‰                                                   |
| --------------------- | -------------------- | ---------------------------------------------------- |
| **id**                | CharField(32), PK    | ä»»åŠ¡å”¯ä¸€ IDï¼ˆä¸€èˆ¬æ˜¯ UUIDï¼‰                                    |
| **doc_id**           | CharField(32), index | å…³è”çš„æ–‡æ¡£ IDï¼ˆå¯¹åº” `document.id`ï¼‰ï¼Œè¡¨ç¤ºè¯¥ä»»åŠ¡å±äºå“ªä¸ªæ–‡æ¡£               |
| **from_page**        | IntegerField         | èµ·å§‹é¡µç ï¼ˆé»˜è®¤ 0ï¼‰ï¼Œä»»åŠ¡å¤„ç†æ–‡æ¡£çš„å¼€å§‹é¡µ                                |
| **to_page**          | IntegerField         | ç»“æŸé¡µç ï¼ˆé»˜è®¤ 100000000ï¼Œå¤§é¡µç è¡¨ç¤ºâ€œåˆ°æœ€åä¸€é¡µâ€ï¼‰                      |
| **task_type**        | CharField(32)        | ä»»åŠ¡ç±»å‹ï¼ˆå¦‚ `"parse"` æ–‡æ¡£è§£æã€ `"chunk"` åˆ‡åˆ†ã€ `"embed"` å‘é‡åŒ–ç­‰ï¼‰ |
| **priority**          | IntegerField         | ä»»åŠ¡ä¼˜å…ˆçº§ï¼Œæ•°å€¼è¶Šé«˜ä¼˜å…ˆæ‰§è¡Œï¼ˆé€šå¸¸ç”¨äºè°ƒåº¦é˜Ÿåˆ—ï¼‰                             |
| **begin_at**         | DateTimeField        | ä»»åŠ¡å¼€å§‹æ‰§è¡Œçš„æ—¶é—´                                            |
| **process_duration** | FloatField           | ä»»åŠ¡è€—æ—¶ï¼ˆç§’ï¼‰                                              |
| **progress**          | FloatField, index    | ä»»åŠ¡è¿›åº¦ï¼ˆ0\~1ï¼Œæˆ–ç™¾åˆ†æ¯”ï¼‰ï¼Œæ¯”å¦‚ 0.5 è¡¨ç¤º 50%                        |
| **progress_msg**     | TextField            | è¿›åº¦è¯´æ˜ä¿¡æ¯ï¼ˆä¾‹å¦‚ `"æ­£åœ¨åˆ‡åˆ†ç¬¬ 10 é¡µ"`ï¼‰                            |
| **retry_count**      | IntegerField         | ä»»åŠ¡é‡è¯•æ¬¡æ•°ï¼ˆå¤±è´¥åä¼šé‡è¯•ï¼‰                                       |
| **digest**            | TextField            | ä»»åŠ¡æ‘˜è¦/è¯´æ˜ï¼ˆå¦‚ä»»åŠ¡çš„é…ç½®å¿«ç…§ï¼Œç”¨äºå¯¹æ¯”ï¼‰                               |
| **chunk_ids**        | LongTextField        | ä»»åŠ¡å¤„ç†ç”Ÿæˆçš„ chunk ID åˆ—è¡¨ï¼ˆä¾‹å¦‚è§£æç»“æœå¯¹åº”çš„æ–‡æœ¬å— IDï¼‰                 |

âœ… æ€»ç»“

* `task` è¡¨æ˜¯ RagFlow **å¼‚æ­¥ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ**çš„æ ¸å¿ƒè¡¨ï¼Œç”¨æ¥è·Ÿè¸ªæ¯ä¸ªæ–‡æ¡£å¤„ç†æ­¥éª¤ã€‚
* ä¸€èˆ¬æµç¨‹ï¼š

  1. ç”¨æˆ·ä¸Šä¼ æ–‡æ¡£ â†’ ç”Ÿæˆ `document` è®°å½•ã€‚
  2. ç³»ç»Ÿä¸ºæ–‡æ¡£ç”Ÿæˆè§£æä»»åŠ¡ â†’ åœ¨ `task` è¡¨æ’å…¥ä¸€æ¡è®°å½•ã€‚
  3. Worker æ¶ˆè´¹ä»»åŠ¡ï¼Œæ›´æ–° `progress`ã€`progress_msg`ã€‚
  4. ä»»åŠ¡å®Œæˆ â†’ å…³è”çš„ `chunk_ids` å­˜å‚¨åˆ°å‘é‡åº“ï¼Œæ–‡æ¡£çŠ¶æ€æ›´æ–°ã€‚
* `retry_count` ç”¨äºå®¹é”™ï¼Œ`priority` ç”¨äºè°ƒåº¦ï¼Œ`digest` ç”¨äºè®°å½•ä»»åŠ¡æ‰§è¡Œæ—¶çš„å‚æ•°å¿«ç…§ã€‚


## 3. æ¨¡å‹ä¸AIèƒ½åŠ›ç®¡ç†
| è¡¨å | ä¸»è¦å­—æ®µ/å…³è” | ä½œç”¨è¯´æ˜ |
|---|---|---|
| `llm_factories` | æ¨¡å‹å‚å•†ç›®å½• |
| `llm` | å‚å•†ä¸‹å…·ä½“æ¨¡å‹æ¸…å•ä¸èƒ½åŠ›æ ‡ç­¾ |
| `tenant_llm` | ç§Ÿæˆ·æ¥å…¥æ¨¡å‹ä¸é…é¢ |
| `tenant_langfuse` | ç§Ÿæˆ·ç»‘å®šçš„å…·ä½“æ¨¡å‹é…ç½®ï¼ˆåŒ…å« API Keyã€Base URLã€é¢åº¦ç­‰ï¼‰ |


### 3.1 æ¨¡å‹å‚å•†ç›®å½•

| å­—æ®µå        | ç±»å‹                                                | å«ä¹‰                                                                                                                           |
| ---------- | ------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| **name**   | CharField(max_length=128, primary_key=True)     | LLM å·¥å‚ï¼ˆæ¨¡å‹æä¾›æ–¹ï¼‰çš„åç§°ï¼Œä½œä¸ºä¸»é”®ï¼Œä¾‹å¦‚ `OpenAI`ã€`Azure`ã€`Anthropic`ã€`ZhipuAI`                                                              |
| **logo**   | TextField(null=True)                              | è¯¥å·¥å‚çš„ Logoï¼ˆBase64 ç¼–ç å­—ç¬¦ä¸²ï¼‰ï¼Œç”¨äºå‰ç«¯å±•ç¤º                                                                                               |
| **tags**   | CharField(max_length=255, null=False)            | å·¥å‚æ”¯æŒçš„èƒ½åŠ›æ ‡ç­¾ï¼Œå…¸å‹å€¼ï¼š<br> - `LLM`ï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰<br> - `Text Embedding`ï¼ˆæ–‡æœ¬å‘é‡åŒ–æ¨¡å‹ï¼‰<br> - `Image2Text`ï¼ˆå›¾åƒè½¬æ–‡å­—ï¼Œä¾‹å¦‚ OCR/Captionï¼‰<br> - `ASR`ï¼ˆè¯­éŸ³è¯†åˆ«ï¼‰ |
| **status** | CharField(max_length=1, default="1", index=True) | å·¥å‚çŠ¶æ€ï¼š<br> - `0` = åºŸå¼ƒ/ä¸å¯ç”¨<br> - `1` = å¯ç”¨ï¼ˆæœ‰æ•ˆï¼‰                                                                                  |


### 3.2 æ¨¡å‹æ¸…å•

| å­—æ®µå             | ç±»å‹                                                | å«ä¹‰                                                                                                       |
| --------------- | ------------------------------------------------- | -------------------------------------------------------------------------------------------------------- |
| **llm_name**   | CharField(max_length=128, index=True)            | æ¨¡å‹åç§°ï¼Œä¾‹å¦‚ï¼š`gpt-4`ã€`text-embedding-ada-002`ã€`claude-3`ã€`glm-4`                                              |
| **model_type** | CharField(max_length=128, index=True)            | æ¨¡å‹ç±»å‹ï¼Œå…¸å‹å€¼ï¼š<br> - `LLM`ï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰<br> - `Text Embedding`ï¼ˆæ–‡æœ¬å‘é‡åŒ–æ¨¡å‹ï¼‰<br> - `Image2Text`ï¼ˆå›¾åƒè½¬æ–‡å­—ï¼‰<br> - `ASR`ï¼ˆè¯­éŸ³è¯†åˆ«ï¼‰ |
| **fid**         | CharField(max_length=128, index=True)            | æ¨¡å‹æ‰€å±å·¥å‚ IDï¼ˆå³ **LLMFactories.name**ï¼‰ï¼Œä¾‹å¦‚ï¼š`OpenAI`ã€`Anthropic`ã€`ZhipuAI`                                     |
| **max_tokens** | IntegerField(default=0)                           | æ¨¡å‹æ”¯æŒçš„æœ€å¤§ token é•¿åº¦ï¼Œä¾‹å¦‚ `4096`ã€`8192`ã€`32768`                                                                |
| **tags**        | CharField(max_length=255, index=True)            | æ¨¡å‹æ ‡ç­¾ï¼Œè¿›ä¸€æ­¥æè¿°æ¨¡å‹ç‰¹æ€§ï¼Œå¦‚ï¼š<br> - `LLM`ï¼ˆé€šç”¨å¤§æ¨¡å‹ï¼‰<br> - `Text Embedding`ï¼ˆå‘é‡åŒ–ï¼‰<br> - `Chat`ï¼ˆå¯¹è¯å¼æ¨¡å‹ï¼‰<br> - `32k`ï¼ˆé•¿ä¸Šä¸‹æ–‡æ¨¡å‹ï¼‰ |
| **is_tools**   | BooleanField(default=False)                       | æ˜¯å¦æ”¯æŒ **å·¥å…·è°ƒç”¨ï¼ˆfunction calling / tool useï¼‰**ï¼Œä¾‹å¦‚ GPT-4 Function Calling                                     |
| **status**      | CharField(max_length=1, default="1", index=True) | æ¨¡å‹çŠ¶æ€ï¼š<br> - `0` = åºŸå¼ƒ/ä¸å¯ç”¨<br> - `1` = æœ‰æ•ˆ/å¯ç”¨                                                               |


### 3.3 ç§Ÿæˆ·æ¨¡å‹é…ç½®
ç§Ÿæˆ·ç»‘å®šçš„å…·ä½“æ¨¡å‹é…ç½®ï¼ˆåŒ…å« API Keyã€Base URLã€é¢åº¦ç­‰ï¼‰ï¼Œæ˜¯**ç§Ÿæˆ·å±‚çº§çš„å®é™…ä½¿ç”¨å…¥å£**

| å­—æ®µå              | ç±»å‹                                                 | å«ä¹‰                                                                                                    |
| ---------------- | -------------------------------------------------- | ----------------------------------------------------------------------------------------------------- |
| **tenant_id**   | CharField(max_length=32, index=True)              | ç§Ÿæˆ· IDï¼Œè¡¨ç¤ºè¯¥é…ç½®å±äºå“ªä¸ªç§Ÿæˆ·ï¼ˆå¤šç§Ÿæˆ·åœºæ™¯ä¸‹åŒºåˆ†ç”¨æˆ·/å›¢é˜Ÿï¼‰                                                                      |
| **llm_factory** | CharField(max_length=128, index=True)             | LLM å·¥å‚åç§°ï¼ˆå¯¹åº” **LLMFactories.name**ï¼‰ï¼Œå¦‚ï¼š`OpenAI`ã€`Anthropic`ã€`ZhipuAI`                                   |
| **model_type**  | CharField(max_length=128, index=True)             | æ¨¡å‹ç±»å‹ï¼Œä¾‹å¦‚ï¼š<br> - `LLM`ï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰<br> - `Text Embedding`ï¼ˆæ–‡æœ¬å‘é‡åŒ–ï¼‰<br> - `Image2Text`ï¼ˆå›¾åƒè½¬æ–‡å­—ï¼‰<br> - `ASR`ï¼ˆè¯­éŸ³è¯†åˆ«ï¼‰ |
| **llm_name**    | CharField(max_length=128, index=True, default="") | æ¨¡å‹åç§°ï¼ˆå¯¹åº” **LLM.llm_name**ï¼‰ï¼Œå¦‚ï¼š`gpt-4`ã€`text-embedding-ada-002`                                         |
| **api_key**     | CharField(max_length=2048, index=True)            | ç§Ÿæˆ·é…ç½®çš„ **æ¨¡å‹ API Key**ï¼ˆé€šå¸¸ç”±ç§Ÿæˆ·è‡ªå·±æä¾›ï¼‰                                                                       |
| **api_base**    | CharField(max_length=255)                         | æ¨¡å‹æœåŠ¡çš„ **API Base åœ°å€**ï¼ˆä¾‹å¦‚ï¼š`https://api.openai.com/v1`ï¼Œæˆ–ç§æœ‰åŒ–éƒ¨ç½²çš„ endpointï¼‰                                |
| **max_tokens**  | IntegerField(default=8192, index=True)             | ç§Ÿæˆ·è®¾ç½®çš„è¯¥æ¨¡å‹æœ€å¤§å¯ç”¨ token æ•°ï¼ˆé»˜è®¤ 8192ï¼Œå¯è¦†ç›–æ¨¡å‹æœ¬èº«çš„é»˜è®¤å€¼ï¼‰                                                             |
| **used_tokens** | IntegerField(default=0, index=True)                | å·²ä½¿ç”¨çš„ token æ•°ï¼Œç”¨äºè®¡è´¹/é™é¢ç»Ÿè®¡                                                                                |



### 3.4 ç§Ÿæˆ· Langfuse é…ç½®
* è¿™å¼ è¡¨ä¸»è¦æ˜¯ **ç»‘å®šç§Ÿæˆ·å’Œ Langfuse çš„ç›‘æ§é…ç½®**ï¼Œè®©ä¸åŒç§Ÿæˆ·èƒ½å°†è°ƒç”¨é“¾è·¯ã€æ—¥å¿—ã€è¯„æµ‹æ•°æ®ä¸ŠæŠ¥åˆ°è‡ªå·±ä¸“å±çš„ Langfuse å®ä¾‹ã€‚


| å­—æ®µå             | ç±»å‹                                           | å«ä¹‰                                    |
| --------------- | -------------------------------------------- | ------------------------------------- |
| **tenant_id**  | CharField(max_length=32, primary_key=True) | ç§Ÿæˆ· IDï¼ˆå¤šç§Ÿæˆ·ç³»ç»Ÿä¸‹çš„å”¯ä¸€æ ‡è¯†ï¼‰ï¼Œä½œä¸ºä¸»é”®ã€‚              |
| **secret_key** | CharField(max_length=2048, index=True)      | Langfuse çš„ **ç§é’¥**ï¼Œç”¨äºæœåŠ¡ç«¯å®‰å…¨é€šä¿¡ï¼ˆé‰´æƒï¼‰ã€‚      |
| **public_key** | CharField(max_length=2048, index=True)      | Langfuse çš„ **å…¬é’¥**ï¼Œé€šå¸¸ç”¨äºå®¢æˆ·ç«¯ SDK ä¸ŠæŠ¥ã€‚     |
| **host**        | CharField(max_length=128, index=True)       | Langfuse æœåŠ¡çš„ **æ¥å…¥åœ°å€**ï¼ˆHost/Endpointï¼‰ã€‚ |


## 4. å¯¹è¯ä¸æ£€ç´¢åº”ç”¨
| è¡¨å | ä½œç”¨ |
|---|---|
| `dialog` | å¯¹è¯åº”ç”¨é…ç½®ï¼ˆæ£€ç´¢+ç”Ÿæˆï¼‰ |
| `conversation` | æŸå¯¹è¯åº”ç”¨ä¸‹çš„ä¼šè¯ä¸æ¶ˆæ¯æ‘˜è¦ |
| `search` | ç‹¬ç«‹æœç´¢é…ç½®ï¼ˆè·¨ KB/Docã€æ£€ç´¢/é‡æ’/é«˜äº®ç­‰ï¼‰ |

### 4.1 dialog

| å­—æ®µå                            | ç±»å‹               | å«ä¹‰                                                                                                     |
| ------------------------------ | ---------------- | ------------------------------------------------------------------------------------------------------ |
| **id**                         | `CharField(32)`  | ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†ä¸€ä¸ªå¯¹è¯åº”ç”¨                                                                                          |
| **tenant_id**                 | `CharField(32)`  | ç§Ÿæˆ· IDï¼ˆå¤šç§Ÿæˆ·éš”ç¦»ç”¨ï¼‰ï¼Œç´¢å¼•å­—æ®µ                                                                                     |
| **name**                       | `CharField(255)` | å¯¹è¯åº”ç”¨åç§°ï¼Œå¸¦ç´¢å¼•                                                                                             |
| **description**                | `TextField`      | å¯¹è¯åº”ç”¨çš„æè¿°ä¿¡æ¯                                                                                              |
| **icon**                       | `TextField`      | åº”ç”¨å›¾æ ‡çš„ base64 ç¼–ç å­—ç¬¦ä¸²                                                                                     |
| **language**                   | `CharField(32)`  | è¯­è¨€ï¼ˆEnglish / Chineseï¼‰ï¼Œé»˜è®¤æ ¹æ®ç³»ç»Ÿç¯å¢ƒå˜é‡ `LANG` è®¾ç½®ï¼Œå¸¦ç´¢å¼•                                                         |
| **llm_id**                    | `CharField(128)` | é»˜è®¤çš„å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ID                                                                                        |
| **llm_setting**               | `JSONField`      | LLM é…ç½®å‚æ•°ï¼ˆé»˜è®¤ï¼š`temperature=0.1, top_p=0.3, frequency_penalty=0.7, presence_penalty=0.4, max_tokens=512`ï¼‰ |
| **prompt_type**               | `CharField(16)`  | Prompt æ¨¡å¼ï¼Œ`simple` æˆ– `advanced`ï¼Œé»˜è®¤ `simple`ï¼Œå¸¦ç´¢å¼•                                                        |
| **prompt_config**             | `JSONField`      | Prompt é…ç½®ï¼ŒåŒ…å« systemã€prologueï¼ˆå¼€åœºç™½ï¼‰ã€parametersï¼ˆå‚æ•°åˆ—è¡¨ï¼‰ã€empty_responseï¼ˆçŸ¥è¯†åº“æ— åŒ¹é…æ—¶çš„å›å¤ï¼‰                         |
| **meta_data_filter**         | `JSONField`      | å…ƒæ•°æ®è¿‡æ»¤æ¡ä»¶ï¼ˆä¾‹å¦‚æŒ‰æ ‡ç­¾/å±æ€§ç­›é€‰çŸ¥è¯†åº“å†…å®¹ï¼‰ï¼Œé»˜è®¤ `{}`                                                                       |
| **similarity_threshold**      | `FloatField`     | å‘é‡å¬å›çš„ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆé»˜è®¤ `0.2`ï¼‰                                                                                   |
| **vector_similarity_weight** | `FloatField`     | å‘é‡ç›¸ä¼¼åº¦çš„æƒé‡ï¼ˆé»˜è®¤ `0.3`ï¼‰                                                                                     |
| **top_n**                     | `IntegerField`   | å‘é‡æ£€ç´¢æ—¶è¿”å›çš„å€™é€‰æ–‡æ¡£æ•°é‡ï¼ˆé»˜è®¤ `6`ï¼‰                                                                                 |
| **top_k**                     | `IntegerField`   | å€™é€‰æ–‡æ¡£æ± çš„æœ€å¤§æ•°é‡ï¼ˆé»˜è®¤ `1024`ï¼‰                                                                                  |
| **do_refer**                  | `CharField(1)`   | æ˜¯å¦åœ¨ç­”æ¡ˆä¸­æ’å…¥å¼•ç”¨ä¿¡æ¯ï¼ˆé»˜è®¤ `"1"` è¡¨ç¤ºéœ€è¦ï¼‰                                                                            |
| **rerank_id**                 | `CharField(128)` | é»˜è®¤çš„ rerankï¼ˆé‡æ’åºï¼‰æ¨¡å‹ ID                                                                                   |
| **kb_ids**                    | `JSONField`      | ç»‘å®šçš„çŸ¥è¯†åº“ ID åˆ—è¡¨ï¼ˆé»˜è®¤ç©ºæ•°ç»„ `[]`ï¼‰                                                                               |
| **status**                     | `CharField(1)`   | åº”ç”¨çŠ¶æ€ï¼ˆ`0`: åºŸå¼ƒ / æ— æ•ˆï¼Œ`1`: æœ‰æ•ˆï¼‰ï¼Œé»˜è®¤ `"1"`ï¼Œå¸¦ç´¢å¼•                                                                |


### 4.2 conversation

| å­—æ®µå            | ç±»å‹               | å«ä¹‰                             |
| -------------- | ---------------- | ------------------------------ |
| **id**         | `CharField(32)`  | ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†ä¸€ä¸ªä¼šè¯                    |
| **dialog_id** | `CharField(32)`  | å…³è”çš„å¯¹è¯åº”ç”¨ï¼ˆ`dialog` è¡¨çš„ `id`ï¼‰ï¼Œç´¢å¼•å­—æ®µ |
| **name**       | `CharField(255)` | ä¼šè¯åç§°ï¼ˆå¯è‡ªå®šä¹‰ï¼‰ï¼Œç´¢å¼•å­—æ®µ                |
| **message**    | `JSONField`      | ä¼šè¯æ¶ˆæ¯å†…å®¹ï¼ˆé€šå¸¸å­˜å‚¨æ¶ˆæ¯å†å²ã€å¯¹è¯ä¸Šä¸‹æ–‡ç­‰ï¼‰        |
| **reference**  | `JSONField`      | ä¼šè¯ç›¸å…³çš„å‚è€ƒä¿¡æ¯ï¼ˆå¦‚çŸ¥è¯†åº“å¼•ç”¨ï¼‰ï¼Œé»˜è®¤ç©ºæ•°ç»„ `[]`   |
| **user_id**   | `CharField(255)` | å‘èµ·ä¼šè¯çš„ç”¨æˆ· IDï¼Œç´¢å¼•å­—æ®µ                |

---

ğŸ“Œ æ€»ç»“ï¼š

* `Dialog` æ˜¯ **åº”ç”¨é…ç½®**ï¼Œå†³å®šäº†è¿™ä¸ªå¯¹è¯åº”ç”¨å¦‚ä½•è¿è¡Œï¼ˆç”¨å“ªä¸ª LLMã€çŸ¥è¯†åº“ã€æ£€ç´¢å‚æ•°ç­‰ï¼‰ã€‚
* `Conversation` æ˜¯ **å®é™…çš„ä¼šè¯å®ä¾‹**ï¼Œä¿å­˜å…·ä½“çš„å¯¹è¯è®°å½•ï¼ˆmessageã€referenceï¼‰ã€ç”¨æˆ·å½’å±ï¼ˆuser_idï¼‰ã€ä»¥åŠå±äºå“ªä¸ªåº”ç”¨ï¼ˆdialog_idï¼‰ã€‚


### 4.3 search

| å­—æ®µå                              | ç±»å‹               | å«ä¹‰                                    |
| -------------------------------- | ---------------- | ------------------------------------- |
| **id**                           | `CharField(32)`  | ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†ä¸€ä¸ªæœç´¢é…ç½®                         |
| **avatar**                       | `TextField`      | æœç´¢é…ç½®çš„å¤´åƒï¼ˆbase64 ç¼–ç å­—ç¬¦ä¸²ï¼‰                 |
| **tenant_id**                   | `CharField(32)`  | æ‰€å±ç§Ÿæˆ· IDï¼Œç´¢å¼•å­—æ®µ                          |
| **name**                         | `CharField(128)` | æœç´¢é…ç½®åç§°ï¼Œå¿…å¡«ï¼Œç´¢å¼•å­—æ®µ                        |
| **description**                  | `TextField`      | æœç´¢é…ç½®æè¿°ï¼ˆé€šå¸¸æ˜¯å¯¹åº”çŸ¥è¯†åº“çš„è¯´æ˜ï¼‰                   |
| **created_by**                  | `CharField(32)`  | åˆ›å»ºè€…çš„ç”¨æˆ· IDï¼Œç´¢å¼•å­—æ®µ                        |
| **search_config**               | `JSONField`      | æœç´¢é…ç½®ï¼ˆæ ¸å¿ƒå­—æ®µï¼‰ï¼ŒåŒ…å«ä»¥ä¸‹å­é¡¹ï¼š                    |
| â””â”€ `kb_ids`                      | `list`           | çŸ¥è¯†åº“ ID åˆ—è¡¨                             |
| â””â”€ `doc_ids`                     | `list`           | æ–‡æ¡£ ID åˆ—è¡¨                              |
| â””â”€ `similarity_threshold`        | `float`          | ç›¸ä¼¼åº¦é˜ˆå€¼ï¼Œé»˜è®¤ 0.2                          |
| â””â”€ `vector_similarity_weight`    | `float`          | å‘é‡ç›¸ä¼¼åº¦æƒé‡ï¼Œé»˜è®¤ 0.3                        |
| â””â”€ `use_kg`                      | `bool`           | æ˜¯å¦ä½¿ç”¨çŸ¥è¯†å›¾è°±ï¼ˆKnowledge Graphï¼‰             |
| â””â”€ `rerank_id`                   | `str`            | é‡æ–°æ’åºæ¨¡å‹ ID                             |
| â””â”€ `top_k`                       | `int`            | æœ€å¤§å¬å›å€™é€‰æ•°é‡ï¼Œé»˜è®¤ 1024                      |
| â””â”€ `summary`                     | `bool`           | æ˜¯å¦å¯ç”¨ç»“æœæ‘˜è¦                              |
| â””â”€ `chat_id`                     | `str`            | å…³è”çš„ä¼šè¯ ID                              |
| â””â”€ `llm_setting`                 | `dict`           | LLM é…ç½®ï¼ˆtemperatureã€top_p ç­‰ï¼Œå¯é€‰ï¼Œä¸è®¾é»˜è®¤å€¼ï¼‰ |
| â””â”€ `chat_settingcross_languages` | `list`           | è·¨è¯­è¨€èŠå¤©è®¾ç½®                               |
| â””â”€ `highlight`                   | `bool`           | æ˜¯å¦é«˜äº®åŒ¹é…ç‰‡æ®µ                              |
| â””â”€ `keyword`                     | `bool`           | æ˜¯å¦å¯ç”¨å…³é”®è¯æ£€ç´¢                             |
| â””â”€ `web_search`                  | `bool`           | æ˜¯å¦å¯ç”¨è”ç½‘æœç´¢                              |
| â””â”€ `related_search`              | `bool`           | æ˜¯å¦å¯ç”¨ç›¸å…³æœç´¢æ¨è                            |
| â””â”€ `query_mindmap`               | `bool`           | æ˜¯å¦å¯ç”¨æŸ¥è¯¢æ€ç»´å¯¼å›¾                            |
| **status**                       | `CharField(1)`   | é…ç½®çŠ¶æ€ï¼Œ`1` è¡¨ç¤ºæœ‰æ•ˆï¼Œ`0` è¡¨ç¤ºæ— æ•ˆï¼Œç´¢å¼•å­—æ®µ           |

---

ğŸ“Œ æ€»ç»“ï¼š

* `Search` è¡¨å°±æ˜¯ä¸€ä¸ª **æœç´¢é…ç½®å®ä½“**ï¼Œæ ¸å¿ƒåœ¨ `search_config`ï¼Œé‡Œé¢æŠŠçŸ¥è¯†åº“ã€æ–‡æ¡£ã€æ£€ç´¢å‚æ•°ã€æ˜¯å¦ç”¨ LLMã€æ˜¯å¦è”ç½‘æœç´¢ç­‰å…¨éƒ¨é…å¥½ã€‚
* è¿™æ ·æ¯ä¸ª `Search` å®ä¾‹å°±ä»£è¡¨ä¸€ç§ **å®šåˆ¶åŒ–æœç´¢æ–¹æ¡ˆ**ï¼Œå¯ä»¥ç”±ä¸åŒç§Ÿæˆ·/ç”¨æˆ·åˆ›å»ºå’Œä½¿ç”¨ã€‚


## 5. å·¥ä½œæµä¸ç¼–æ’
| è¡¨å | ä½œç”¨ |
|---|---|
| `user_canvas` | ç”¨æˆ·ç”»å¸ƒï¼ˆç¼–æ’/å·¥ä½œæµï¼‰å®ä¾‹ |
| `canvas_template` | ç”»å¸ƒæ¨¡æ¿åº“ |
| `user_canvas_version` | ç”»å¸ƒç‰ˆæœ¬å†å² |

### 5.1 user_canvas

| å­—æ®µå           | ç±»å‹        | å«ä¹‰                               |
| ------------- | --------- | -------------------------------- |
| `id`          | CharField | Canvas çš„å”¯ä¸€æ ‡è¯†ï¼Œä¸»é”®                  |
| `avatar`      | TextField | Canvas å¤´åƒï¼Œå­˜å‚¨ä¸º Base64 å­—ç¬¦ä¸²         |
| `user_id`     | CharField | ç”¨æˆ· IDï¼Œæ ‡è¯† Canvas æ‰€å±ç”¨æˆ·             |
| `title`       | CharField | Canvas æ ‡é¢˜                        |
| `permission`  | CharField | æƒé™ç±»å‹ï¼Œå¯é€‰ `"me"`ï¼ˆç§æœ‰ï¼‰æˆ– `"team"`ï¼ˆå›¢é˜Ÿï¼‰ |
| `description` | TextField | Canvas æè¿°                        |
| `canvas_type` | CharField | Canvas ç±»å‹                        |
| `dsl`         | JSONField | Canvas çš„ DSL æ•°æ®ï¼Œå­˜å‚¨ JSON          |


### 5.2 canvas_template

| å­—æ®µå           | ç±»å‹        | å«ä¹‰                          |
| ------------- | --------- | --------------------------- |
| `id`          | CharField | Canvas æ¨¡æ¿çš„å”¯ä¸€æ ‡è¯†ï¼Œä¸»é”®           |
| `avatar`      | TextField | Canvas æ¨¡æ¿çš„å¤´åƒï¼Œå­˜å‚¨ä¸º Base64 å­—ç¬¦ä¸² |
| `title`       | CharField | Canvas æ¨¡æ¿æ ‡é¢˜                 |
| `description` | TextField | Canvas æ¨¡æ¿æè¿°                 |
| `canvas_type` | CharField | Canvas ç±»å‹                   |
| `dsl`         | JSONField | Canvas æ¨¡æ¿çš„ DSL æ•°æ®ï¼Œå­˜å‚¨ JSON   |

### 5.3 user_canvas_version

| å­—æ®µå              | ç±»å‹        | å«ä¹‰                              |
| ---------------- | --------- | ------------------------------- |
| `id`             | CharField | Canvas ç‰ˆæœ¬çš„å”¯ä¸€æ ‡è¯†ï¼Œä¸»é”®               |
| `user_canvas_id` | CharField | æ‰€å±çš„ UserCanvas IDï¼Œç”¨äºå…³è”å…·ä½“ Canvas |
| `title`          | CharField | Canvas ç‰ˆæœ¬æ ‡é¢˜                     |
| `description`    | TextField | Canvas ç‰ˆæœ¬æè¿°                     |
| `dsl`            | JSONField | Canvas ç‰ˆæœ¬çš„ DSL æ•°æ®ï¼Œå­˜å‚¨ JSON       |


## 6. APIä¸é›†æˆç®¡ç†
| è¡¨å | ä½œç”¨ |
|---|---|
| `user` | ç”¨æˆ·è´¦å·ä¿¡æ¯ä¸ç™»å½•å±æ€§ |
| `tenant` | ç§Ÿæˆ·/å·¥ä½œåŒºï¼Œé»˜è®¤æ¨¡å‹ä¸é¢åº¦é…ç½® |
| `user_tenant` | ç”¨æˆ·ä¸ç§Ÿæˆ·çš„å…³ç³»ä¸è§’è‰² |
| `invitation_code` | é‚€è¯·ç ä¸å—é‚€è®°å½• |
| `api_token` | API è®¿é—®ä»¤ç‰Œï¼ˆå¯ç»‘å®šåº”ç”¨/æ¥æºï¼‰ |
| `api_4_conversation` | API è°ƒç”¨äº§ç”Ÿçš„ä¼šè¯ä¸ç”¨é‡/é”™è¯¯æ—¥å¿— |
| `mcp_server` | MCP Server æ³¨å†Œä¸è°ƒç”¨é…ç½® |

### 6.1 user

| å­—æ®µå                   | ç±»å‹               | å«ä¹‰                                                  |                        |
| --------------------- | ---------------- | --------------------------------------------------- | ---------------------- |
| **id**                | `CharField(32)`  | ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†ç”¨æˆ·                                           |                        |
| **access_token**     | `CharField(255)` | ç”¨æˆ·çš„è®¿é—®ä»¤ç‰Œï¼ˆç”¨äºé‰´æƒï¼‰ï¼Œç´¢å¼•å­—æ®µ                                  |                        |
| **nickname**          | `CharField(100)` | ç”¨æˆ·æ˜µç§°ï¼Œå¿…å¡«ï¼Œç´¢å¼•å­—æ®µ                                        |                        |
| **password**          | `CharField(255)` | ç™»å½•å¯†ç ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰ï¼Œç´¢å¼•å­—æ®µ                                     |                        |
| **email**             | `CharField(255)` | é‚®ç®±ï¼Œå¿…å¡«ï¼Œç”¨æˆ·çš„ä¸»è¦ç™»å½•æ ‡è¯†ï¼Œç´¢å¼•å­—æ®µ                                |                        |
| **avatar**            | `TextField`      | ç”¨æˆ·å¤´åƒï¼ˆbase64 ç¼–ç å­—ç¬¦ä¸²ï¼‰                                  |                        |
| **language**          | `CharField(32)`  | ç”¨æˆ·è¯­è¨€åå¥½ï¼Œé»˜è®¤æ ¹æ®ç³»ç»Ÿ `LANG` å˜é‡è®¾ç½®ï¼ˆ"Chinese"/"English"ï¼‰ï¼Œç´¢å¼•å­—æ®µ |                        |
| **color_schema**     | `CharField(32)`  | é¢œè‰²ä¸»é¢˜ï¼ˆBright                                         | Darkï¼‰ï¼Œé»˜è®¤ "Bright"ï¼Œç´¢å¼•å­—æ®µ |
| **timezone**          | `CharField(64)`  | ç”¨æˆ·æ—¶åŒºï¼Œé»˜è®¤ `"UTC+8 Asia/Shanghai"`ï¼Œç´¢å¼•å­—æ®µ                |                        |
| **last_login_time** | `DateTimeField`  | æœ€è¿‘ä¸€æ¬¡ç™»å½•æ—¶é—´ï¼Œç´¢å¼•å­—æ®µ                                       |                        |
| **is_authenticated** | `CharField(1)`   | æ˜¯å¦å·²è®¤è¯ï¼Œé»˜è®¤ `"1"`ï¼Œç´¢å¼•å­—æ®µ                                 |                        |
| **is_active**        | `CharField(1)`   | æ˜¯å¦æ´»è·ƒç”¨æˆ·ï¼Œé»˜è®¤ `"1"`ï¼Œç´¢å¼•å­—æ®µ                                |                        |
| **is_anonymous**     | `CharField(1)`   | æ˜¯å¦åŒ¿åç”¨æˆ·ï¼Œé»˜è®¤ `"0"`ï¼Œç´¢å¼•å­—æ®µ                                |                        |
| **login_channel**    | `CharField`      | ç”¨æˆ·ç™»å½•æ¥æºï¼ˆå¦‚ webã€ç¬¬ä¸‰æ–¹ç™»å½•ï¼‰ï¼Œç´¢å¼•å­—æ®µ                            |                        |
| **status**            | `CharField(1)`   | ç”¨æˆ·çŠ¶æ€ï¼Œ`1` æœ‰æ•ˆï¼Œ`0` æ— æ•ˆï¼Œé»˜è®¤ `"1"`ï¼Œç´¢å¼•å­—æ®µ                    |                        |
| **is_superuser**     | `BooleanField`   | æ˜¯å¦è¶…çº§ç®¡ç†å‘˜ï¼ˆroot æƒé™ï¼‰ï¼Œé»˜è®¤ `False`ï¼Œç´¢å¼•å­—æ®µ                    |                        |

---

é¢å¤–è¯´æ˜

* **ç»§æ‰¿å…³ç³»**

  * `DataBaseModel`ï¼šåº”ç”¨çš„ Peewee åŸºç¡€æ¨¡å‹ï¼Œå°è£…äº†é€šç”¨æ•°æ®åº“é…ç½®ã€‚
  * `UserMixin`ï¼šé€šå¸¸æ¥è‡ª `flask_login`ï¼Œæä¾›ç”¨æˆ·è®¤è¯ç›¸å…³çš„é»˜è®¤æ–¹æ³•ï¼ˆå¦‚ `is_authenticated`ã€`is_active` ç­‰ï¼‰ã€‚

* **æ–¹æ³•**

  * `__str__`ï¼šè¿”å›ç”¨æˆ·é‚®ç®±ï¼Œä¾¿äºæ‰“å°æˆ–è°ƒè¯•ã€‚
  * `get_id`ï¼šä½¿ç”¨ `itsdangerous.Serializer` å¯¹ `access_token` è¿›è¡ŒåŠ å¯†åè¿”å›ï¼Œé€šå¸¸ç”¨äºä¼šè¯æˆ– JWT ç™»å½•é‰´æƒã€‚


### 6.2 tenant

| å­—æ®µå             | ç±»å‹               | å«ä¹‰                                     |
| --------------- | ---------------- | -------------------------------------- |
| **id**          | `CharField(32)`  | ä¸»é”®ï¼Œç§Ÿæˆ·å”¯ä¸€æ ‡è¯†                              |
| **name**        | `CharField(100)` | ç§Ÿæˆ·åç§°ï¼Œç´¢å¼•å­—æ®µ                              |
| **public_key** | `CharField(255)` | ç§Ÿæˆ·å…¬é’¥ï¼Œç”¨äºé‰´æƒæˆ– API è°ƒç”¨ï¼Œç´¢å¼•å­—æ®µ                 |
| **llm_id**     | `CharField(128)` | é»˜è®¤ä½¿ç”¨çš„å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„ IDï¼Œç´¢å¼•å­—æ®µ               |
| **embd_id**    | `CharField(128)` | é»˜è®¤ä½¿ç”¨çš„å‘é‡åŒ–ï¼ˆembeddingï¼‰æ¨¡å‹ IDï¼Œç´¢å¼•å­—æ®µ          |
| **asr_id**     | `CharField(128)` | é»˜è®¤ä½¿ç”¨çš„è¯­éŸ³è¯†åˆ«ï¼ˆASRï¼‰æ¨¡å‹ IDï¼Œç´¢å¼•å­—æ®µ               |
| **img2txt_id** | `CharField(128)` | é»˜è®¤ä½¿ç”¨çš„å›¾åƒè½¬æ–‡æœ¬æ¨¡å‹ IDï¼Œç´¢å¼•å­—æ®µ                   |
| **rerank_id**  | `CharField(128)` | é»˜è®¤ä½¿ç”¨çš„é‡æ’åºæ¨¡å‹ IDï¼Œç´¢å¼•å­—æ®µ                     |
| **tts_id**     | `CharField(256)` | é»˜è®¤ä½¿ç”¨çš„æ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰æ¨¡å‹ IDï¼Œç´¢å¼•å­—æ®µ              |
| **parser_ids** | `CharField(256)` | æ–‡æ¡£è§£æå™¨ï¼ˆdocument processorsï¼‰çš„ ID åˆ—è¡¨ï¼Œç´¢å¼•å­—æ®µ |
| **credit**      | `IntegerField`   | ç§Ÿæˆ·å¯ç”¨é¢åº¦ï¼ˆå¦‚è°ƒç”¨æ¬¡æ•°/ç§¯åˆ†ï¼‰ï¼Œé»˜è®¤ `512`ï¼Œç´¢å¼•å­—æ®µ         |
| **status**      | `CharField(1)`   | ç§Ÿæˆ·çŠ¶æ€ï¼š`1` æœ‰æ•ˆï¼Œ`0` æ— æ•ˆï¼Œé»˜è®¤ `"1"`ï¼Œç´¢å¼•å­—æ®µ       |

---

é¢å¤–è¯´æ˜

* **ç§Ÿæˆ·æ¦‚å¿µ**

  * ä¸€èˆ¬ SaaS ç³»ç»Ÿä¸­çš„ **å¤šç§Ÿæˆ·éš”ç¦»è®¾è®¡**ã€‚
  * æ¯ä¸ªç§Ÿæˆ·å¯ä»¥é…ç½®è‡ªå·±çš„ **é»˜è®¤æ¨¡å‹**ï¼ˆLLMã€Embeddingã€ASRã€TTS ç­‰ï¼‰ã€‚
  * `credit` å¯ç†è§£ä¸ºé¢åº¦æˆ–ä½™é¢æ§åˆ¶ã€‚

* **æ¨¡å‹å…³è”**

  * `llm_id`ã€`embd_id`ã€`asr_id`ã€`tts_id` ç­‰å­—æ®µé€šå¸¸ä¼šå¯¹åº”åˆ° **æ¨¡å‹è¡¨**ï¼ˆæˆ–å¤–éƒ¨æ¨¡å‹æœåŠ¡ IDï¼‰ï¼Œä¾¿äºå¿«é€Ÿåˆ‡æ¢ã€‚
  * `parser_ids` è¯´æ˜æ¯ä¸ªç§Ÿæˆ·å¯ä»¥ç»‘å®šä¸€ç»„ **æ–‡æ¡£é¢„å¤„ç†å™¨**ï¼ˆä¾‹å¦‚ OCRã€åˆ†è¯ã€ç»“æ„åŒ–æå–ç­‰ï¼‰ã€‚

---

ğŸ“Œ æ€»ç»“ï¼š
`Tenant` è¡¨å®šä¹‰äº† **å¤šç§Ÿæˆ·ä½“ç³»çš„é…ç½®ä¸­å¿ƒ**ï¼Œä¸»è¦ä½œç”¨æ˜¯ï¼š

1. æ ‡è¯†ä¸åŒç§Ÿæˆ·ï¼ˆå…¬å¸/ç»„ç»‡ï¼‰ã€‚
2. å­˜å‚¨æ¯ä¸ªç§Ÿæˆ·çš„é»˜è®¤æ¨¡å‹é…ç½®ã€‚
3. æ§åˆ¶ç§Ÿæˆ·çš„å¯ç”¨é¢åº¦å’Œæœ‰æ•ˆçŠ¶æ€ã€‚


### 6.3 user_tenant

| å­—æ®µå             | ç±»å‹              | å«ä¹‰                                     |
| --------------- | --------------- | -------------------------------------- |
| **id**          | `CharField(32)` | ä¸»é”®ï¼Œç”¨æˆ·-ç§Ÿæˆ·å…³ç³»å”¯ä¸€æ ‡è¯†                         |
| **user_id**    | `CharField(32)` | ç”¨æˆ· IDï¼Œå…³è”åˆ° `user.id`ï¼Œç´¢å¼•å­—æ®µ               |
| **tenant_id**  | `CharField(32)` | ç§Ÿæˆ· IDï¼Œå…³è”åˆ° `tenant.id`ï¼Œç´¢å¼•å­—æ®µ             |
| **role**        | `CharField(32)` | ç”¨æˆ·åœ¨è¯¥ç§Ÿæˆ·ä¸‹çš„è§’è‰²ï¼ˆä¾‹å¦‚ `admin`ã€`member` ç­‰ï¼‰ï¼Œç´¢å¼•å­—æ®µ |
| **invited_by** | `CharField(32)` | é‚€è¯·è¯¥ç”¨æˆ·åŠ å…¥ç§Ÿæˆ·çš„ **é‚€è¯·äºº ID**ï¼ˆé€šå¸¸ä¹Ÿæ˜¯æŸä¸ªç”¨æˆ·ï¼‰ï¼Œç´¢å¼•å­—æ®µ   |
| **status**      | `CharField(1)`  | ç”¨æˆ·-ç§Ÿæˆ·å…³ç³»çš„çŠ¶æ€ï¼š`1` æœ‰æ•ˆï¼Œ`0` æ— æ•ˆï¼Œé»˜è®¤ `"1"`ï¼Œç´¢å¼•å­—æ®µ |

---

é¢å¤–è¯´æ˜

* **è§’è‰²ç®¡ç†ï¼ˆrole å­—æ®µï¼‰**

  * ç”¨æ¥åŒºåˆ†ç”¨æˆ·åœ¨ç§Ÿæˆ·ä¸­çš„æƒé™ï¼Œä¾‹å¦‚ï¼š

    * `owner`ï¼šç§Ÿæˆ·åˆ›å»ºè€…
    * `admin`ï¼šç§Ÿæˆ·ç®¡ç†å‘˜
    * `member`ï¼šæ™®é€šæˆå‘˜
  * åœ¨ RBACï¼ˆåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ï¼‰é‡Œéå¸¸å¸¸è§ã€‚

### 6.4 invitation_code

| å­—æ®µå             | ç±»å‹              | å«ä¹‰                                    |
| --------------- | --------------- | ------------------------------------- |
| **id**          | `CharField(32)` | ä¸»é”®ï¼Œé‚€è¯·ç è®°å½•å”¯ä¸€æ ‡è¯†                          |
| **code**        | `CharField(32)` | é‚€è¯·ç å­—ç¬¦ä¸²ï¼Œä½œä¸ºå”¯ä¸€è¯†åˆ«å’Œæ ¡éªŒçš„å‡­è¯ï¼Œç´¢å¼•å­—æ®µ              |
| **visit_time** | `DateTimeField` | é‚€è¯·ç è¢«ä½¿ç”¨æˆ–è®¿é—®çš„æ—¶é—´ï¼Œç”¨äºè¿½è¸ªä½¿ç”¨æƒ…å†µ                 |
| **user_id**    | `CharField(32)` | ä½¿ç”¨è¯¥é‚€è¯·ç çš„ç”¨æˆ· IDï¼Œç´¢å¼•å­—æ®µ                     |
| **tenant_id**  | `CharField(32)` | è¯¥é‚€è¯·ç æ‰€å±çš„ç§Ÿæˆ· IDï¼Œç´¢å¼•å­—æ®µ                     |
| **status**      | `CharField(1)`  | é‚€è¯·ç çŠ¶æ€ï¼š`1` æœ‰æ•ˆï¼Œ`0` å¤±æ•ˆï¼ˆåºŸå¼ƒï¼‰ï¼Œé»˜è®¤ `"1"`ï¼Œç´¢å¼•å­—æ®µ |


### 6.5 api_token

| å­—æ®µå            | ç±»å‹               | å«ä¹‰                                                                                              |
| -------------- | ---------------- | ----------------------------------------------------------------------------------------------- |
| **tenant_id** | `CharField(32)`  | ç§Ÿæˆ· IDï¼Œè¡¨æ˜è¯¥ API Token å±äºå“ªä¸ªç§Ÿæˆ·ï¼Œä¸»é”®çš„ä¸€éƒ¨åˆ†                                                               |
| **token**      | `CharField(255)` | API Token å­—ç¬¦ä¸²ï¼ˆå”¯ä¸€è¯†åˆ« API è°ƒç”¨è€…çš„å‡­è¯ï¼‰ï¼Œä¸»é”®çš„ä¸€éƒ¨åˆ†                                                           |
| **dialog_id** | `CharField(32)`  | å…³è”çš„å¯¹è¯åº”ç”¨ IDï¼ˆå¦‚æœè¯¥ Token é™å®šåœ¨æŸä¸ªå¯¹è¯åº”ç”¨åœºæ™¯ä¸‹ä½¿ç”¨ï¼‰ï¼Œå¯ä¸ºç©º                                                        |
| **source**     | `CharField(16)`  | Token æ¥æºï¼Œç”¨äºæ ‡è®°ç”¨é€”ï¼š<br> - `none`ï¼šæ™®é€šç”¨é€” <br> - `agent`ï¼šä»£ç†æ¨¡å¼ä¸‹ç”Ÿæˆçš„ Token <br> - `dialog`ï¼šå¯¹è¯åº”ç”¨ä¸‹ç”Ÿæˆçš„ Token |
| **beta**       | `CharField(255)` | é¢„ç•™å­—æ®µï¼ˆå®éªŒåŠŸèƒ½æ ‡è¯†æˆ– Beta åŠŸèƒ½å¼€å…³ï¼‰ï¼Œå¯ä¸ºç©º                                                                     |


### 6.6 api_4_conversation
API è°ƒç”¨äº§ç”Ÿçš„ä¼šè¯ä¸ç”¨é‡/é”™è¯¯æ—¥å¿—

| å­—æ®µå            | ç±»å‹               | å«ä¹‰                             |       |               |
| -------------- | ---------------- | ------------------------------ | ----- | ------------- |
| **id**         | `CharField(32)`  | ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†ä¸€æ¡ API ä¼šè¯è®°å½•             |       |               |
| **dialog_id** | `CharField(32)`  | å…³è”çš„å¯¹è¯åº”ç”¨ IDï¼Œç´¢å¼•å­—æ®µ                |       |               |
| **user_id**   | `CharField(255)` | å‘èµ·ä¼šè¯çš„ç”¨æˆ· IDï¼Œç´¢å¼•å­—æ®µ                |       |               |
| **message**    | `JSONField`      | API ä¼šè¯ä¸­çš„æ¶ˆæ¯å†…å®¹ï¼ˆè¾“å…¥/è¾“å‡ºå†å²ï¼‰          |       |               |
| **reference**  | `JSONField`      | ä¼šè¯å‚è€ƒä¿¡æ¯ï¼ˆå¦‚çŸ¥è¯†åº“å¼•ç”¨ï¼‰ï¼Œé»˜è®¤ç©ºæ•°ç»„ `[]`      |       |               |
| **tokens**     | `IntegerField`   | ä¼šè¯æ¶ˆè€—çš„ token æ•°é‡ï¼Œé»˜è®¤ `0`          |       |               |
| **source**     | `CharField(16)`  | ä¼šè¯æ¥æºï¼Œ\`none                    | agent | dialog\`ï¼Œç´¢å¼•å­—æ®µ |
| **dsl**        | `JSONField`      | é¢å¤–çš„ DSL æˆ–è‡ªå®šä¹‰æŒ‡ä»¤ä¿¡æ¯ï¼Œé»˜è®¤ç©ºå­—å…¸ `{}`    |       |               |
| **duration**   | `FloatField`     | æœ¬æ¬¡ä¼šè¯è€—æ—¶ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ `0`ï¼Œç´¢å¼•å­—æ®µ          |       |               |
| **round**      | `IntegerField`   | ä¼šè¯è½®æ¬¡ï¼ˆæ¶ˆæ¯è½®æ•°ï¼‰ï¼Œé»˜è®¤ `0`ï¼Œç´¢å¼•å­—æ®µ         |       |               |
| **thumb_up**  | `IntegerField`   | ç”¨æˆ·ç‚¹èµæ•°ï¼ˆå¯¹æœ¬è½®æˆ–æœ¬æ¬¡ä¼šè¯çš„è¯„ä»·ï¼‰ï¼Œé»˜è®¤ `0`ï¼Œç´¢å¼•å­—æ®µ |       |               |
| **errors**     | `TextField`      | ä¼šè¯å¤„ç†ä¸­çš„é”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•æˆ–æ—¥å¿—è¿½è¸ª           |       |               |

---

é¢å¤–è¯´æ˜

* **ç”¨é€”**

  * ç”¨äºè®°å½• **é€šè¿‡ API å‘èµ·çš„ä¼šè¯**ï¼ŒåŒºåˆ«äºå‰ç«¯ç›´æ¥çš„ `Conversation`ã€‚
  * æ”¯æŒç»Ÿè®¡ token ä½¿ç”¨é‡ã€å“åº”è€—æ—¶å’Œç”¨æˆ·è¯„ä»·ã€‚

* **å…³è”å…³ç³»**

  * `dialog_id` â†’ å¯¹åº”æŸä¸ªå¯¹è¯åº”ç”¨ï¼ˆDialogï¼‰ã€‚
  * `user_id` â†’ è®°å½•æ˜¯å“ªä½ç”¨æˆ·å‘èµ·çš„ API è°ƒç”¨ã€‚
  * `source` â†’ åŒºåˆ†è°ƒç”¨æ¥æºï¼š

    * `none`ï¼šé»˜è®¤
    * `agent`ï¼šä»£ç†è°ƒç”¨
    * `dialog`ï¼šé€šè¿‡å¯¹è¯åº”ç”¨è§¦å‘

* **æ€§èƒ½/ç»Ÿè®¡æŒ‡æ ‡**

  * `tokens`ã€`duration`ã€`round`ã€`thumb_up` å¯ä»¥ç”¨äº **è®¡è´¹ã€æ€§èƒ½ç›‘æ§ã€ç”¨æˆ·è¡Œä¸ºåˆ†æ**ã€‚

---

ğŸ“Œ æ€»ç»“ï¼š
`API4Conversation` æ˜¯ **API å±‚ä¼šè¯æ—¥å¿—è¡¨**ï¼Œæ¯” `Conversation` æ›´åå‘ **è°ƒç”¨ç›‘æ§å’Œç»Ÿè®¡**ï¼Œè®°å½• token æ¶ˆè€—ã€è€—æ—¶ã€è½®æ¬¡ã€æ¥æºå’Œé”™è¯¯ä¿¡æ¯ï¼Œæ–¹ä¾¿ **å®¡è®¡ä¸åˆ†æ API ä½¿ç”¨æƒ…å†µ**ã€‚


### 6.7 mcp_server
ğŸ‘Œ æˆ‘æ¥å¸®ä½ æ•´ç† `MCPServer` è¿™å¼ è¡¨çš„å­—æ®µè¯´æ˜ï¼š

---

### `mcp_server` è¡¨å­—æ®µè¯´æ˜

| å­—æ®µå              | ç±»å‹                | å«ä¹‰                               |
| ---------------- | ----------------- | -------------------------------- |
| **id**           | `CharField(32)`   | ä¸»é”®ï¼Œå”¯ä¸€æ ‡è¯†ä¸€ä¸ª MCP Server å®ä¾‹          |
| **name**         | `CharField(255)`  | MCP Server åç§°ï¼Œå¿…å¡«                 |
| **tenant_id**   | `CharField(32)`   | æ‰€å±ç§Ÿæˆ· IDï¼Œç´¢å¼•å­—æ®µ                     |
| **url**          | `CharField(2048)` | MCP Server çš„è®¿é—® URLï¼Œå¿…å¡«            |
| **server_type** | `CharField(32)`   | MCP Server ç±»å‹ï¼ˆä¾‹å¦‚ä»»åŠ¡è°ƒåº¦ã€æ•°æ®å¤„ç†ç­‰ï¼‰ï¼Œå¿…å¡«   |
| **description**  | `TextField`       | MCP Server æè¿°ä¿¡æ¯                  |
| **variables**    | `JSONField`       | MCP Server é…ç½®å˜é‡ï¼ˆé”®å€¼å¯¹ï¼‰ï¼Œé»˜è®¤ç©ºå­—å…¸ `{}`  |
| **headers**      | `JSONField`       | MCP Server è¯·æ±‚å¤´ä¿¡æ¯ï¼ˆé”®å€¼å¯¹ï¼‰ï¼Œé»˜è®¤ç©ºå­—å…¸ `{}` |


