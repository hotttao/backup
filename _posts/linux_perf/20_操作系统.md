---
title: 4. 操作系统
date: 2020-01-15
categories:
    - 运维
tags:
    - Linux性能调优
---

从本文开始我们将进入Linux性能优化的第二阶段，操作系统部分。操作系统原理是复杂的，不可能也没有能力把操作系统都将清楚。我们会列出每个部分相关的关键术语，并就其中与性能优化相关的关键部分进行讲解。本文是一个关于操作系统和内核知识的概览，为后面做一点准备。

<!-- more -->

## 1. 术语
与操作系统相关的术语:
1. 进程: 一个 OS 的抽象概念，是用来执行程序的环境，运行在用户模式(用户态)，通过系统调用或自陷来进入内核模式
2. 线程: 可被调度的运行在 CPU上的可执行上下文
3. 系统调用: 一套明确定义的协议，为用户程序请求内核执行特权操作
4. 自陷: 信号发送到内核，请求执行一段系统程序(特权操作)，自陷类型包括系统调用、处理器异常以及中断
5. 中断: 由物理设备发送到内核的信号，通常是请求 I/O 服务，中断是自陷的一种类型

## 2. 内核
### 2.1 时钟
UNIX 内核的一个核心组件是 clock() 例程，从一个计时器中断执行，每执行一次成为一个 tick。功能包括更新系统时间，计时器和线程调度时间片的到时结束，维护CPU计数器，以及执行 callout(内核调度例程)。

但是 clock() 曾经有过性能问题。现代内核已经把许多功能移出了 clock 例程，放到了按需中断中，这是为了努力创造无 tick 内核。包括 Linux 在内，clock 例程即系统计时器中断，除了更新系统时钟和更新 jiffies 计数器之外，执行的工作很少。jiffies 是 Linux 的时间单元与 tick 类似。

### 2.2 内核态
用户进程通过系统调用执行内核特权操作时，会做上下文切换，从用户态到内核态。

无论是用户态还是内核态，都有自己的软件执行上下文，包括栈和寄存器。这些状态切换上下文是会耗费 CPU 周期的，这对每次I/O都增加了一小部分的时间开销。

### 2.3 用户栈和内核栈
执行系统调用时，一个进程的线程有两个栈: 一个用户级别栈和一个内核级别的栈。线程被阻塞时，用户级别的栈在系统调用期间不会改变，当执行在内核上下文时，线程用的是一个单独的内核级别栈。此处有一个例外，信号处理程序取决于其配置，可以借用用户级别的栈。

### 2.4 中断和中断线程
![interrupt](/images/linux_pf/interrupt.png)

中断被内核用来响应设备的服务请求，分为:
1. 中断服务程序: 需要通过注册来处理设备中断，这类程序需要运行的尽可能块，以减少对活动线程中断的影响。如果中断要做的工作不少，尤其是可能被阻塞，最好通过中断线程来处理，由内核调度
2. 对于Linux，设备驱动分为两个部分:
    - 上半部分用于快速处理中断，因为上半部分运行在中断禁止模式，会推迟新的中断的产生
    - 下半部分可以作为tasklet 或者工作队列，之后由内核做线程调度
3. 从中断开始到中断被服务之间的时间叫做中断延时

### 2.5 设备驱动
设备驱动是用于设备管理和设备I/O的内核软件，有硬件开发厂商提供。

## 3. 进程
进程包括进程地址空间内的数据和内核里的元数据(上下文)：
1. 内核上下文包含各种进程属性和统计信息
2. 每一线程都包含一些元数据，包括在内核上下文里自己的优先级以及用户地址空间里自己的栈。

![Process environment](/images/linux_pf/process_enviroment.png)

### 3.1 调度器
分时系统，通过划分执行时间，让多个进程同时运行。进程在处理器上和CPU间的调度是由调度器完成的。调度器操作线程(Linux 中是任务 task)，并将它们隐射到 CPU 上。

![kernel_schduler](/images/linux_pf/kernel_schduler.png)

 ## 4. 虚拟内存
![vritual_memory](/images/linux_pf/vritual_memory.png)

### 4.1 内存管理
当虚拟内存用二级存储(磁盘)作为主存的扩展时，内存管理决定哪些数据保存在主存中。


## 5. 文件系统
### 5.1 VFS
虚拟文件系统 VFS 是一个文件系统类型作抽象的内核界面。VFS 接口让内核添加新的文件系统时更加简单。

![vfs](/images/linux_pf/vfs.png)

### 5.2 I/O 栈
基于存储设备的文件系统，从用户级软件到存储设备的路径被称为 I/O 栈

![io_stack](/images/linux_pf/io_stack.png)
