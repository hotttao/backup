---
title: 4.13 网络
date: 2020-01-28
categories:
    - 运维
tags:
    - Linux性能调优
---
本节我们讲解网络相关的操作系统原理。网络分析的目的除了改进网络延时和吞吐量外，另一个常见的任务是消除可能由丢包引起的延时异常。网络分析是跨硬件和软件的。硬件指的是物理网络包括网络接口卡，交换机，路由器和网管。软件指的是内核协议栈。
<!-- more -->

## 1. 网络
本节我们将从以下几个方面介绍网络相关的操作系统原理:
1. 网络协议栈
2. TCP 连接状态转移
3. TCP 拥塞控制
4. 操作系统的网络栈

最后我们会介绍网络相关的检测指标。想对网络深入了解，推荐大家阅读:
1. [CCNA学习指南](https://book.douban.com/subject/2968802/)
2. [TCP/IP详解 卷1：协议](https://book.douban.com/subject/1088054/)

## 1. 网络协议栈
网络的五层和七层模型想必大家都听过，下面是这两个协议栈模型的示意图:

![network_model](/images/linux_pf/network_model.png)

数据经过网络协议栈时，通过包封装将每层协议的元数据添加到负载前(包头)，之后(包后)，或者二者，但不会修改负载数据。下面展示了以太网 TCP/IP 的栈封装过程:

![tcp_encapsulation](/images/linux_pf/tcp_encapsulation.png)

数据就是这样经过封装，并通过路由器等网络设备在网络上进行传播，并最后被目标主机接收和解析。

![network_trans](/images/linux_pf/network_trans.png)

## 2. TCP 状态转移
[TCP 状态转移](http://www.pianshen.com/article/9701265948/)


### 2.1 长连接和短连接
长连接和短连接除了关闭连接的时机，更重要的是长连接需要有一个保活机制。

## 3. TCP 拥塞控制
TCP 的滑动窗口，拥塞控制可以看这篇文章[图解TCP 重传、滑动窗口、流量控制、拥塞控制发愁](https://www.cnblogs.com/xiaolincoding/p/12732052.html)，图文并茂很容易理解。

## 4. 操作系统的网络栈
网络通信软件包括网络栈、TCP和设备驱动程序。下面是一个通用的网络栈模型。

![network_stack](/images/linux_pf/network_stack.png)
- ARP: 地址解析协议
- Data Link(generic net driver): 数据链路，通用网络驱动软件
- NIC: 网卡: 网卡是发送和接收网络包的基本设备。在系统启动过程中，网卡通过内核中的网卡驱动程序注册到系统中。而在网络收发过程中，内核通过中断跟网卡进行交互。

网络的收发的过程中，网卡硬中断只处理最核心的网卡数据读取或发送，而协议栈中的大部分逻辑，都会放到软中断中处理。

### 4.1 网络包收发过程
![tcp_send](/images/linux_pf/tcp_send.png)

#### 网络包的收过程
当一个网络帧到达网卡后:
1. 网卡会通过 DMA 方式，把这个网络包放到**收包队列**中；然后通过硬中断，告诉中断处理程序已经收到了网络包。
2. DMA(Direct Memory Access，直接存储器访问) 允许不同速度的硬件装置来沟通，而不需要依赖于 CPU 的大量中断负载
3. 网卡中断处理程序会为网络帧分配内核数据结构（sk_buff），并将其拷贝到 sk_buff 缓冲区中；然后再通过软中断，通知内核收到了新的网络帧。
4. 内核协议栈从缓冲区中取出网络帧，并通过网络协议栈，从下到上逐层处理这个网络帧。
    - 在链路层检查报文的合法性，找出上层协议的类型（比如 IPv4 还是 IPv6），再去掉帧头、帧尾，然后交给网络层。
    - 网络层取出 IP 头，判断网络包下一步的走向,当网络层确认这个包是要发送到本机后，就会取出上层协议的类型（比如 TCP 还是 UDP），去掉 IP 头，再交给传输层处理
    - 传输层取出 TCP 头或者 UDP 头后，根据 < 源 IP、源端口、目的 IP、目的端口 > 四元组作为标识，找出对应的 Socket，并把数据拷贝到 Socket 的接收缓存中。
    - 最后，应用程序就可以使用 Socket 接口，读取到新接收到的数据了。

#### 网络包的发送过程
网络包的发送方向，正好跟接收方向相反:
1. 应用程序调用 Socket API（比如 sendmsg）发送网络包。由于这是一个系统调用，所以会陷入到内核态的套接字层中。套接字层会把数据包放到 Socket 发送缓冲区中。
2. 接下来，网络协议栈从 Socket 发送缓冲区中，取出数据包；再按照 TCP/IP 栈，从上到下逐层处理。
3. 这一切完成后，会有软中断通知驱动程序：**发包队列**中有新的网络帧需要发送。
4. 最后，驱动程序通过 DMA ，从发包队列中读出网络帧，并通过物理网卡把它发送出去。

更加详细的收发过程详见[Linux网络包收发总体过程](https://www.cnblogs.com/zhjh256/p/12227883.html)

### 4.2 Linux
Linux 中 TCP，IP以及通用网络驱动软件是内核的核心组件，设备驱动程序是附加模块，数据包以 struct_sk_buff 数据类型穿过这些内核组件。通用驱动程序能通过合并中断提高性能。

数据包的高处理器率通过调用多个 CPU 处理包和 TCP/IP 栈。Linux3.7 记录了如下不同的方法:
1. RSS，接收端缩放: 现代 NIC 支持多个队列并且计算包哈希以放置不同的队列，而后依次按直接中断由不同的 CPU 处理。这个哈希值可能基于 IP和TCP 端口，因此源自同一连接的包能被同一个 CPU 处理。
2. RPS，接收数据包转向: 对于不支持多队列的NIC的RSS关键实现。一个短中断服务例行程序映射传入的数据包给 CPU 处理，用一个类似的哈希按数据包头的字段映射数据包到 CPU
3. RFS，接收流转向: 类似 RPS，不过偏向前一个处理套接字的CPU，以提高CPU缓存命中率和内存本地性
4. 加速接收数据流转向: 对于支持该功能的NIC，这是 RFS 的硬件实现。它用流信息更新NIC以确定中断哪个CPU
5. XPS，传输数据包转向: 对于支持多个传输队列的NIC，这支持多个 CPU传输队列

当缺乏数据包的CPU负载均衡时，NIC会中断同一个CPU，进而达到100% 的使用率并成为瓶颈。

基于例如RFS 实现的缓存一致性等因素而映射中断到多个 CPU，能显著提升网络性能。这样能通过 irqbalancer 进程实现，它能分配中断请求 IRQ 给 CPU。

注:NIC 是网络接口卡的简称

### 4.3 积压队列和缓冲
#### 积压队列
突发的链接由积压队列处理。这里有两个队列:
1. 一个在TCP 握手完成前处理未完成的连接，又称为SYN积压队列
2. 另一个处理等待应用程序接受的已建立的会话，又称为侦听积压队列

![backlog_queues](/images/linux_pf/backlog_queues.png)

有两个队列的情况下第一个可作为潜在的伪造连接的集结地，仅在连接建立后才迁移到第二个队列，此队列可以设置的很长以吸收海量 SYN，并且优化为仅存放最少的必要元数据
第二个队列可由应用程序 listent() 的积压队列参数设置。

#### 缓冲
利用套接字的发送和接收缓冲能够提升数据的吞吐量:

![socket_buffer](/images/linux_pf/socket_buffer.png)

对于写通道，数据缓冲在 TCP发送缓冲区，然后送往IP发送。尽管IP协议有能力分段数据包，TCP仍试图发送 MSS 长度的段给IP以避免这种情况。这意味重发送单位对应分段的单位，否则一个被丢弃的数据段会导致整个分段前的数据包被重新传输。由于避免了分段和组装常规数据包，这种实现方式提升了 TCP/IP 栈的效率。

缓冲区的大小是可调整的。Linux 会基于连接的活跃度自动调节缓冲区大小。

#### 网络设备驱动
网络设备驱动通常还有一个附加的缓冲区(环形缓冲区 DMA)用于在内核内存与NIC间发送和接收数据包。

随着10GbE以太网网的引入，利用**中断结合模式**的利于性能的功能愈发常见。一个中断仅仅在计时器激活或者达到一定数据量的包时才被发送，而不是每当有数据包达到就中断内核。这降低了内核与 NIC 通信的频率。允许缓冲更多的发送，从而达到更高的吞吐量。


## 5. 网络监测
下面是网络常用的性能测量指标:
1. 延时
2. 带宽: 表示链路的最大传输速率
3. 吞吐量: 表示单位时间内成功传输的数据量，吞吐量 / 带宽，也就是该网络的使用率。
4. PPS: PPS，是 Packet Per Second（包 / 秒），表示以网络包为单位的传输速率。PPS 通常用来评估网络的转发能力
3. 应用层指标: 
    - 网络的可用性（网络能否正常通信）
    - 并发连接数（TCP 连接数量）
    - 丢包率（丢包百分比）
    - 重传率（重新传输的网络包比例）等也是常用的性能指标。


### 5.1 延时
延时是一个重要的网络性能指标，并且有多种测量方法，包括:
1. 主机名解析延时
2. ping 延时
3. 连接延时
4. 首字节延时
5. 往返延时

### 5.2 带宽、吞吐量和PPS
网络吞吐量和 PPS 可以使用 sar 命令查看。带宽的查看可以使用 ethtool 工具。

### 使用率
网络连接口的使用率可以用当前的吞吐量除以最大带宽来计算。但是考虑到可变的带宽和自动协商的双工模式，计算不像看上去那么简单。对于全双工，使用率适合每个方向且用该方向当前的吞吐量除以当前协商的带宽来计算。

### 饱和度
测量连接积压队列导致的丢包是一种衡量网络连接饱和度的方法