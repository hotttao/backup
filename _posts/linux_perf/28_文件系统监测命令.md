---
title: 4.8 文件系统监测命令
date: 2020-01-23
categories:
    - 运维
tags:
    - Linux性能调优
---

本节我们来介绍文件系统相关的监测工具。
<!-- more -->

## 1. 命令总览
我们会介绍如下文件系统统计信息的工具

|Linux|Solaris|作用|说明|
|:---|:---|:---|:---|
||vfsstat|文件系统统计信息，包括平均延时||
||fsstat|文件系统统计信息||
||kstat|各种文件系统和缓存统计信息|
||fcachestat|各种缓存命令中率和大小||
|free||缓存容量统计信息||
|strace|truss|系统调用调试器||
|slaptop|mdb:kmastat|内核 slab 分配器统计信息||
|/proc/memeinfo|mdb:memstat|内核内存使用情况||
|sar|sar|内存，swap使用统计信息|通用命令，位于独立的一节中|

除此之外，还包括以下内容:
1. 文件系统基准测试
2. 文件系统调优

## 2. 文件系统统计命令
### 2.1 LatencyTop
LatencyTop 是一个报告延时根源的工具。可以针对整个系统，也可以针对单个进程。

启用 LatencyTop 需要两个内核选项的支持:
1. CONFIG_LATENCYTOP
2. CONFIG_HAVE_LATENCYTOP_SUPPORT

```bash
# 1. LatencyTop 启用
> yum install latencytop
> rpm -ql latencytop
# 2. LatencyTop 查看
> cat /proc/latency_stats
```

## 3. 文件系统测试
### 3.1 dd
可以执行文件系统连续读写负载的特定性能测试
```bash
> dd if=/dev/zero of=file1 bs=1024k count=1k
> dd if=file1 of=/dev/null bs=1024
```
### 3.2 Bonnie
是一个在单文件上一单线程测试集中负载的简单 C程序

### 3.3 fio
有很多高级功能的可定制文件系统基准测试工具:
1. 非标准随机分布，可以更准确的模拟真实的访问模式
2. 延时百分位数报告，包括 99,99.5,99.9,99.99

### 3.4 SysBench

### 3.5 丢弃缓存
Linux 提供了丢弃缓存的方法，可用于缓存开始执行的基准测试
```
# 丢弃页缓存
> ehco 1 > /proc/sys/vm/drop_cache

# 丢弃 dentries 和 inodes 缓存
> ehco 2 > /proc/sys/vm/drop_cache

# 丢弃所有缓存
> ehco 3 > /proc/sys/vm/drop_cache
```

## 4. 调优
### 4.1 应用程序调优
应用程序可以给内核提供信息，来提高缓存和预期的效率，包括:
1. posix_fadvise()
2. madvise()

#### posix_fasvise()
`int posix_fasvise(int fd, off_t offset, off_t len, int advice)`
- 作用: 这个库函数调用操作文件的一个区域
- advice: 建议标志位:
    - POSIX_FAD_SEQUENTIAL: 指定的数据范围会被连续访问 
    - POSIX_FAD_RANDOM: 指定的数据范围会被随机访问
    - POSIX_FAD_NOREUSE: 数据不会被重用
    - POSIX_FAD_WILLNEED: 数据会在不远的将来重用
    - POSIX_FAD_DONTNEED: 数据不会在不远的将来重用

#### madvise()
`int madvise(void *addr, size_t length, int advice`
- 作用: 库函数调用对一块内存映射进行操作
- advice: 建议标志位
    - MADV_RANDOM: 偏移量将以随机顺序访问
    - MADV_SEQUENTIAL: 偏移量将以连续顺序访问
    - MADV_WILLNEED: 数据还会再用，请缓存
    - MADV_DONTNEED: 数据不会再用，无缓存

### 4.2 文件系统调优
#### ext 文件系统
```bash
# 1. 查看文件系统配置
> tunefs -l dev_name
> mount 
# 2. 可以使用选项 noatime 禁用文件访问时间戳更新

# 3. tunefs 提升性能的关键选项 -- 使用哈希B数提高大目录的查找速度
> tune2fs -O dir_index /dev/hdX

# 4. 重建文件系统目录的索引
> e2fsck -D -f /dev/hdX
```