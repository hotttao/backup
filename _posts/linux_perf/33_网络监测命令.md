---
title: 4.14 网络监测命令
date: 2020-01-29
categories:
    - 运维
tags:
    - Linux性能调优
---

本节我们来介绍内存相关的监测工具。
<!-- more -->

## 1. 命令总览
我们会介绍如下磁盘统计信息的工具

|Linux|Solaris|作用|说明|
|:---|:---|:---|:---|
|netstat,ss|netstat|多种网络栈和接口统计信息||
|sar||统计信息历史||
|ifconfig|ifconfig|接口配置||
|ip|ip|网络配置接口统计信息||
|nicstat|nicstat|网络接口吞吐量和使用率||
|ethtool|ethtool|查看网络接口的带宽|
|ping|ping|测试网络连通性||
|traceroute|traceroute|测试网络路由||
|pathchar|pathchar|确定网络路径特征||
|tcpdump|tcpdump/snoop|网络数据报嗅探器||
|Wireshark|Wireshark|图形化网络数据包检查器||
|DTrace,perf|DTrace|TCP/IP栈跟踪: 连接、数据包、丢包、延时||

除此之外，还包括以下内容:
1. 网络基准测试
2. 网络调优

### 1.1 网络相关的理论
阅读中遇到下面不理解的概念，记录如下:  
1. [TCP TIME-WAIT](https://zhenbianshu.github.io/2018/12/talk_about_tcp_timewait.html)
2. CPU 扇出
3. 链路聚合

## 2. 网络统计命令
网络的统计信息由以下两个文件提供:
1. /proc/net/snmp
2. /proc/net/netstat


### 2.1 ss
ss options
- 作用: 多种网络栈和接口统计信息
- 选项:
    - 套接字: 
        - 默认: 列出连接的套接字
        - -a: 列出所有套接字的信息
        - -4：只显示ipv4的套接字；
        - -6：只显示ipv6的套接字；
        - -t：只显示tcp套接字；
        - -n：不解析服务名称，以数字方式显示；
        - -l：显示处于监听状态的套接字；
        - -u：只显示udp套接字；
        - -d：只显示DCCP套接字；
        - -w：仅显示RAW套接字；
        - -x：仅显示UNIX域套接字
        - -S: display only SCTP sockets
        - -f: 显示 FAMILY类型的套接字，FAMILY可选包括 inet|inet6|link|unix|netlink|vsock|help
    - 套接字相关资源:
        - -m：显示套接字的内存使用情况
        - -p：显示使用套接字的进程信息
        - -E: continually display sockets as they are destroyed
        - -Z: display process SELinux security contexts
        - -z: display process and socket SELinux security contexts
        - -K: forcibly close sockets, display what was closed
    - 统计信息:    
        - -s: 网络栈统计信息
        - -i: 网络接口信息
    - 输出控制:
        - -o: 显示计时器信息
        - -D, --diag=FILE 将原始TCP套接字（sockets）信息转储到文件
        - -N: switch to the specified network namespace name
        - -e: show detailed socket information
        - -A, --query=QUERY, --socket=QUERY，QUERY 包括:
            - all|inet|tcp|udp|raw|unix
            - unix_dgram|unix_stream|unix_seqpacket|packet|
            - netlink|vsock_stream|vsock_dgram
```bash
 ss -s
Total: 283 (kernel 0)
# ss 只显示已经连接、关闭、孤儿套接字等简要统计
TCP:   14 (estab 2, closed 1, orphaned 0, synrecv 0, timewait 0/0), ports 0

Transport Total     IP        IPv6
*         0         -         -
RAW       0         0         0
UDP       11        8         3
TCP       13        8         5
INET      24        16        8
FRAG      0         0         0
```

### 2.2 netsat
`netstat [-vWeenNcCF] [<Af>] -r`   
`netstat [-vWnNcaeol] [<Socket> ...]`  
`netstat { [-vWeenNac] -I[<Iface>] | [-veenNac] -i | [-cnNe] -M | -s [-6tuw] } [delay]`
- 选项:
    - 统计选项:
        - -i: 显示网络接口信息
        - -s: 显示网络栈统计信息 
    - 系统信息:
        - -p: 显示使用套接字的进程信息
        - -r: 显示路由表
        - -g：显示多重广播功能群组组员名单
        - -M: 显示伪装的网络连线
        - -F: display Forwarding Information Base (default)
        - -C: display routing cache instead of FIB
        - -Z: 显示套接字的 SELinux 信息
    - 显示控制:
        - -v, --verbose            be verbose
        - -W, --wide               don't truncate IP addresses
        - -n: 显示 IP 地址
        - -N: 显示网络硬件外围设备的符号连接名称；
        - -e: 显示扩展信息
        - -o: 显示计时器
        - -c: 持续输出
    - 套接字筛选:
        - -a: 列出所有套接字的信息
        - -l: 显示处于监听状态的套接字
        - -t|--tcp
        - -u|--udp
        - -U|--udplite
        - -S|--sctp
        - -w|--raw
        - -x|--unix
        - --ax25 
        - --ipx 
        - --netrom
        - -6: inet6 (IPv6)
        - -4: inet (IPV4)

#### netstat -i
常与 -c 一起使用，每秒输出下面的累计计数。
```bash
Kernel Interface table
Iface             MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg
enp0s3           1500   140998      0      0 0         12029      0      0      0 BMRU
lo              65536      107      0      0 0           107      0      0      0 LRU
virbr0           1500        0      0      0 0             0      0      0      0 BMU
virbr0-nic       1500        0      0      0 0             0      0      0      0 BMU
```
输出:
1. ifcae: 网络接口
2. MTU
3. 一系列的接收(RX-)和传输(TX-)
    - OK: 成功传输的数据包
    - ERR: 错误数据包
    - DRP: 丢包 - 网络接口是否饱和指针
    - OVR: 超限 - 网络接口是否饱和指针

#### netstat -s
```bash
$ netstat -s
Ip:
    21721 total packets received
    0 forwarded
    0 incoming packets discarded
    15111 incoming packets delivered
    10909 requests sent out
    98 dropped because of missing route
Icmp:
    0 ICMP messages received
    0 input ICMP message failed.
    ICMP input histogram:
    244 ICMP messages sent
    0 ICMP messages failed
    ICMP output histogram:
        destination unreachable: 244
IcmpMsg:
        OutType3: 244
Tcp:
    14 active connections openings
    17 passive connection openings
    0 failed connection attempts
    0 connection resets received
    2 connections established
    14307 segments received
    9608 segments send out
    4 segments retransmited
    0 bad segments received.
    8 resets sent
....
```

理解上面的信息需要对 TCP行为有着深刻的理解。下面是值的查找的示例指标:
1. 相比接收的总数据包更高速率的包转发，检查服务器是否需要转发数据包
2. 更高的数据段重传输率
3. 套接字缓冲超限导致的数据包从接收队列中删除

重要字段:
1. tcpListenDrops： tcp 丢包数量

#### netstat -nlp
查询套接字信息：
```bash
# -l 表示只显示监听套接字
# -t 表示只显示 TCP 套接字
# -n 表示显示数字地址和端口(而不是名字)
# -p 表示显示进程信息
$ ss -ltnp | head -n 3
State    Recv-Q    Send-Q        Local Address:Port        Peer Address:Port
LISTEN   0         128           127.0.0.53%lo:53               0.0.0.0:*        users:(("systemd-resolve",pid=840,fd=13))
LISTEN   0         128                 0.0.0.0:22               0.0.0.0:*        users:(("sshd",pid=1459,fd=3))
```

其中，接收队列（Recv-Q）和发送队列（Send-Q）需要你特别关注，它们通常应该是 0。当你发现它们不是 0 时，说明有网络包的堆积发生。当然还要注意，在不同套接字状态下，它们的含义不同。

套接字处于连接状态（Established）时:
1. Recv-Q 表示套接字缓冲还没有被应用程序取走的字节数（即接收队列长度）。
2. Send-Q 表示还没有被远端主机确认的字节数（即发送队列长度）。

套接字处于监听状态（Listening）时
1. Recv-Q 表示全连接队列的长度(全连接队列的长度就是上一篇文章所说的侦听积压队列的长度)
2. Send-Q 表示全连接队列的最大长度


### 2.3 ifconfig/ip
```bash
ifconfig
ens33: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.44.128  netmask 255.255.255.0  broadcast 192.168.44.255
        ether 00:0c:29:74:60:60  txqueuelen 1000  (Ethernet)     # txqueuelen 为接口发送队列的长度
        RX packets 59072  bytes 32261953 (30.7 MiB)              # 同 netstat -i 的输出
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 14288  bytes 2090118 (1.9 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

ip -s link
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00  
    RX: bytes  packets  errors  dropped overrun mcast           # 同 netstat -i 的输出
    10284      108      0       0       0       0
    TX: bytes  packets  errors  dropped carrier collsns
    10284      108      0       0       0       0

```

指标含义:
1. 网络接口的状态标志。ifconfig 输出中的 RUNNING ，或 ip 输出中的 LOWER_UP ，都表示物理网络是连通的，即网卡已经连接到了交换机或者路由器中。如果你看不到它们，通常表示网线被拔掉了。
2. ifconfig txqueuelen:
    - 表示接口发送队列的长度
    - 对于速度较低的高延时设备，设置较小的值有助于预防高速的大量传输影响
3. TX 和 RX 部分的 errors、dropped、overruns、carrier 以及 collisions 
    - errors 表示发生错误的数据包数，比如校验错误、帧同步错误等；
    - dropped 表示丢弃的数据包数，即数据包已经收到了 Ring Buffer，但因为内存不足等原因丢包；
    - overruns 表示超限数据包数，即网络 I/O 速度过快，导致 Ring Buffer 中的数据包来不及处理（队列满）而导致的丢包；
    - carrier 表示发生 carrirer 错误的数据包数，比如双工模式不匹配、物理电缆出现问题等；
    - collisions 表示碰撞数据包数。

### 2.4 pathchar
pathchar ip:
- 作用: 类似于 traceroute，并且包括了每一跳间的带宽
- 缺点: 找不到可运行的版本，并且运行非常耗时

### 2.5 tcpdump
tcpdump
- 作用: 捕获并分析网络数据包
- 注意: CPU 和存储而言，捕获数据包是昂贵的，应在尽可能短的时间内使用
- 选项:
    - -i: 指定网络接口卡   
    - -n: 禁止 IP 地址反解
    - -v: 显示数据包详细细节
    - -e: 显示链路层报头
    - -x: 十六进制地址转换
    - -ttt: 时间戳显示为数据包间的时间差
    - -tttt: 时间戳显示为第一个数据包以来的时间差
```bash
# 1. 将 eth4 接口的数据写入文件
tcpdump -i etch4 -w /tmp/out.tcpdump

# 2. 从导出的文件中检查数据包
tcpdump -nr /tmp/out.tcpdump

# 3. 监听 etho0 tcp 80 端口的网络包
tcpdump -i eth0 -n tcp port 80
```

### 2.6 hping3
hping3
- 作用: 
    - 可以构造 TCP/IP 协议数据包的工具
    - 可以对系统进行安全审计、防火墙测试等
- 参数:
    -  -S: 表示设置TCP协议的SYN（同步序列号），
    -  -p: 表示目的端口为80
    -  -i u100: 表示每隔100微秒发送一个网络帧

```bash
$ hping3 -S -p 80 -i u100 192.168.0.30
```

### 2.7 ethtool
`ethtool DEVICENAME`
- 作用: 查看网络接口的各种信息

```bash
ethtool enp0s3
Settings for enp0s3:
        Supported ports: [ TP ]
        Supported link modes:   10baseT/Half 10baseT/Full
                                100baseT/Half 100baseT/Full
                                1000baseT/Full
        Supported pause frame use: No
        Supports auto-negotiation: Yes
        Supported FEC modes: Not reported
        Advertised link modes:  10baseT/Half 10baseT/Full
                                100baseT/Half 100baseT/Full
                                1000baseT/Full
        Advertised pause frame use: No
        Advertised auto-negotiation: Yes
        Advertised FEC modes: Not reported
        Speed: 1000Mb/s                       # 网络接口的带宽
        Duplex: Full
        Port: Twisted Pair
        PHYAD: 0
        Transceiver: internal
        Auto-negotiation: on
        MDI-X: off (auto)
        Supports Wake-on: umbg
        Wake-on: d
        Current message level: 0x00000007 (7)
                               drv probe link
        Link detected: yes
```