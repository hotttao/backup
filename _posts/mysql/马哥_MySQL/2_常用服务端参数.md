---
title: 2 MYSQL 常用服务端参数
date: 2019-10-07
categories:
    - 存储
tags:
    - 马哥 MySQL 运维
---

mariadb 常用服务端参数

<!-- more -->

## 1. mariadb 特性参数
### 1.1 SQL_MODE
SQL_MODE
- 作用: 设置 sql 模式，sql 模式会影响值溢出等行为的处理方式

### 1.2 QUERY_CACHE_TYPE
QUERY_CACHE_TYPE
- 作用: 是否启用查询缓存
- 可选值:
  - OFF: 不启用，显示指定 SQL_CACHE 也不会缓存
  - ON: 启用，可以使用 SQL_NO_CACHE 显示指定不缓存查询结果
  - DEMAND: 按需启用，即可以使用 SQL_CACHE 显示指定缓存查询结果


### 1.3 事务隔离级别设置
TX_ISOLATION
- 作用: 设置事务的隔离级别
- 可选值:
  - REPEATABLE-READ: 可重复度
  - READ-UNCOMMITTED: 读未提交
  - READ-COMMITTED: 读提交
  - SERIALIZABLE: 串行化

事务日志配置:
- innodb_log_files_in_group: 一个事务日志组中包含几个文件
- innodb_log_group_home_dir：事务日志所在的目录
- innodb_log_file_size：事务日志的大小

```bash
select @@session.tx_isolation;

show global variables like "innodb%log%";
+----------------------------------+-----------+
| Variable_name                    | Value     |
+----------------------------------+-----------+
| innodb_encrypt_log               | OFF       |
| innodb_flush_log_at_timeout      | 1         |
| innodb_flush_log_at_trx_commit   | 1         |
| innodb_locks_unsafe_for_binlog   | OFF       |
| innodb_log_buffer_size           | 16777216  |
| innodb_log_checksums             | ON        |
| innodb_log_compressed_pages      | ON        |
| innodb_log_file_size             | 50331648  |
| innodb_log_files_in_group        | 2         |
| innodb_log_group_home_dir        | ./        |
| innodb_log_optimize_ddl          | ON        |
| innodb_log_write_ahead_size      | 8192      |
| innodb_max_undo_log_size         | 10485760  |
| innodb_online_alter_log_max_size | 134217728 |
| innodb_scrub_log                 | OFF       |
| innodb_scrub_log_speed           | 256       |
| innodb_undo_log_truncate         | OFF       |
| innodb_undo_logs                 | 128       |
+----------------------------------+-----------+
```

## 2. 网络连接
WAIT_TIMEOUT:
- 作用: 空闲连接的最大连接时长

连接管理: 
- 连接分为短连接，长连接，长时间空闲的链接连接称为空闲连接
- 空闲连接的保持时长由 wait_timeout 参数配置，默认为 8 小时，超时后连接就会自动断开
- 全部使用长连接后，有些时候 MySQL 占用内存涨得特别快，这是因为 MySQL 在执行过程中临时使用的内存是管理在连接对象里面的。这些资源会在连接断开的时候才释放。所以如果长连接累积下来，可能导致内存占用太大，被系统强行杀掉（OOM），从现象看就是 MySQL 异常重启了，解决办法有如下两个:
  - 定期断开长连接。使用一段时间，或者程序里面判断执行过一个占用内存的大查询后，断开连接，之后要查询再重连。
  - MySQL>=5.7，可以在每次执行一个比较大的操作后，通过执行 mysql_reset_connection 来重新初始化连接资源。这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。

## 3. 日志
### redo log
1. innodb_flush_log_at_trx_commit: 
	- 作用: 事务提交之后多久更新 redo log
	- 建议: 设置为 1 表示每次事务的 redo log 都直接持久化到磁盘。建议设置成 1，这样可以保证 MySQL 异常重启之后数据不丢失

### bin log
2. sync_binlog:
	- 作用: 表示事务提交之后多久更新 bin log
	- 建议: 设置为 1 表示每次事务的 binlog 都持久化到磁盘。建议设置成 1，这样可以保证 MySQL 异常重启之后 binlog 不丢失

### change buffer
1. innodb_change_buffer_max_size: 
	- 作用: change buffer 用的是 buffer pool 里的内存，此参数用于控制 changer buffer 能够占用 buffer pool 最大百分比
	- 示例: =50 表示 change buffer 的大小最多只能占用 buffer pool 的 50%。

#### 刷脏页
1. innodb_io_capacity: 设置磁盘的 IO 能力
2. innodb_max_dirty_pages_pct: 脏页比例的上线
3. innodb_flush_neighbors: 刷脏页时是否刷新邻居脏页