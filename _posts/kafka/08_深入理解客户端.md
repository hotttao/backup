---
title: 8 深入理解客户端
date: 2020-04-08
categories:
    - 存储
tags:
    - Kafka
---

从客户端入手，深入地挖掘Kafka的实现原理

<!-- more -->

## 1. 内容概述
本章我们将从客户端的角度入手，同时涉及客户端和服务端的内容，以便深入地挖掘Kafka的实现原理，内容包括:
1. 分区分配策略
2. 消费者协调器和组协调器
3. _consumer_offset

## 2. 分区分配策略
前面我们讲解了消费者和消费组的模型，客户端参数`partition.assignment.strategy`来设置消费者与订阅主题之间的分区分配策略，它如下几个策略:
1. RangeAssignor: 默认策略，值为 org.apache.kafka.clients.consumer.RangeAssignor
2. RoundRobinAssignor 值为 org.apache.kafka.clients.consumer.RoundRobinAssignor
3. StickyAssignor

消费者客户端参数 partition.assignment.strategy可以配置多个分配策略，彼此之间以逗号分隔。

### 2.1 RangeAssignor
RangeAssignor 分配策略的原理是
1. 按照消费者总数和分区总数进行整除运算来获得一个跨度，然后将分区按照跨度进行平均分配，以保证分区尽可能均匀地分配给所有的消费者
3. 对于每一个主题，RangeAssignor策略会将消费组内所有订阅这个主题的消费者按照名称的字典序排序，然后为每个消费者划分固定的分区范围

假设消费组内有2个消费者C0和C1，都订阅了主题t0和t1，并且每个主题都有3个分区，则RangeAssignor 分区分配结果是

```bash
消费者C0: t0p0, t0p1, t1p0, t1p1
消费者C1: t0p2, t1p2
```

### 2.2 RoundRobinAssignor
RoundRobinAssignor分配策略的原理是将消费组内所有消费者及消费者订阅的所有主题的分区按照字典序排序，然后通过轮询方式逐个将分区依次分配给每个消费者。

如果同一个消费组内所有的消费者的订阅信息都是相同的，那么RoundRobinAssignor分配策略的分区分配会是均匀的。

如果同一个消费组内的消费者订阅的信息是不相同的，那么在执行分区分配的时候就不是完全的轮询分配，有可能导致分区分配得不均匀。如果某个消费者没有订阅消费组内的某个主题，那么在分配分区的时候此消费者将分配不到这个主题的任何分区。

### 2.3 StickyAssignor
引入 StickyAssignor 策略，主要有两个目的:
1. 分区的分配要尽可能均匀。
2. 分区的分配尽可能与上次分配的保持相同。

当两者发生冲突时，第一个目标优先于第二个目标。使用StickyAssignor分配策略的一个优点就是可以使分区重分配具备“黏性”，减少不必要的分区移动（即一个分区剥离之前的消费者，转而分配给另一个新的消费者）。

## 3. 消费者协调器和组协调器