---
title: 1.6 日志索引
date: 2020-04-06
categories:
    - 存储
tags:
    - Kafka
---

本节我们来介绍 kafka 服务端的相关设计，包括网络协议设计、时间轮、延迟操作、控制器及参数解密。
<!-- more -->

## 1. 网络协议
Kafka自定义了一组基于TCP的二进制协议，在 Kafka 2.0.0 中，一共包含了 43 种协议类型，每种协议类型都有对应的请求（Request）和响应（Response），每种类型的Request都包含相同结构的协议请求头（RequestHeader）和不同结构的协议请求体。

![request](/images/kafka/request.png)

## 2. 时间轮
延时操作的实现

## 3. 延时操作
### 3.1 延时生产

### 3.2 延时拉取

## 4. 控制器
在 Kafka 集群中会有一个或多个 broker，其中有一个 broker 会被选举为控制器（Kafka Controller），它负责
1. 管理整个集群中所有分区和副本的状态。当某个分区的leader副本出现故障时，由控制器负责为该分区选举新的leader副本。
2. 当检测到某个分区的ISR集合发生变化时，由控制器负责通知所有broker更新其元数据信息。
3. 当使用kafka-topics.sh脚本为某个topic增加分区数量时，同样还是由控制器负责分区的重新分配。

Kafka中的控制器选举工作依赖于ZooKeeper，成功竞选为控制器的broker会在ZooKeeper中创建/controller这个临时（EPHEMERAL）节点。

ZooKeeper 中还有一个与控制器有关的/controller_epoch 节点，这个节点是持久（PERSISTENT）节点，节点中存放的是一个整型的controller_epoch值。controller_epoch用于记录控制器发生变更的次数，即记录当前的控制器是第几代控制器，我们也可以称之为“控制器的纪元”。

### 4.1 控制职责
