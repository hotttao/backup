---
title: 7. 保护模式
date: 2021-07-07
categories:
    - Go
tags:
	- x86 汇编
---

保护模式
<!-- more -->
## 1. 内容概述
前面我们学习了 8086 处理器实模式的汇编技巧。接下来我们就进入到 32位保护模式的汇编内容部分。所谓模式对应着一种处理器架构。本节我们将介绍 32位处理器的基本知识、概念和基本特性。

## 1. 32位处理器
Intel 32 位处理器架构简称IA-32（Intel Architecture，32-bit），是以1978 年的8086 处理器为基础发展起来的，有延续性和兼容性。处理器由 16 位发展到 32 位，不单单是地址线和数据线的扩展，实际上还有更多的部分，包括高速缓存、流水线、浮点处理部件、多处理器（核）管理、多媒体扩展、乱序执行、分支预测、虚拟化、温度和电源管理等。

### 1.1 寄存器
32 位处理器在16 位处理器的基础上，扩展了这8 个通用寄存器的长度，扩展（Extend）的寄存器的名字分别是EAX、EBX、ECX、EDX、ESI、EDI、ESP 和EBP。32 位通用寄存器的高16 位是不可独立使用的，但低16 位保持同16 位处理器的兼容性。因此，在任何时候它们都可以照往常一样使用。与此同时32 位处理器扩展了IP，使之达到32 位，即EIP，标志寄存器FLAGS则扩展为 EFLAGS。

## 1.2 段选择子
在32 位模式下，对内存的访问从理论上来说不再需要分段，因为它有32 根地址线，可以自由访问任何一个内存位置。但是，IA-32 架构的处理器是基于分段模型的，因此，32 位处理器依然需要以段为单位访问内存，即使它工作在32 位模式下。
不过，它也提供了一种变通的方案，即，只分一个段，段的基地址是0x00000000，段的长度（大小）是4GB。在这种情况下，可以视为不分段，即平坦模型（Flat Mode）。

在32 位模式下，处理器要求在加载程序时，先定义该程序所拥有的段，然后允许使用这些段。定义段时，除了基地址（起始地址）外，还附加了段界限、特权级别、类型等属性。当程序访问一个段时，处理器将用固件实施各种检查工作，以防止对内存的违规访问。

如下图所示，在32 位模式下，传统的段寄存器，如CS、SS、DS、ES，保存的不再是16位段基地址，而是段的选择子，即，用于选择所要访问的段，因此，严格地说，它的新名字叫做段选择器。除了段选择器之外，每个段寄存器还包括一个不可见部分，称为描述符高速缓存器，里面有段的基地址和各种访问属性。这部分内容程序不可访问，由处理器自动使用。

![段选择子](/images/assembly/ia_32.png)

80386，以及所有后续的32 位处理器，都兼容实模式，可以运行实模式下的8086 程序。而且，在刚加电时，这些处理器都自动处于实模式下，此时，它相当于一个非常快速的8086 处理器。只有在进行一番设置之后，才能运行在保护模式下。

### 1.3 线性地址
IA-32 处理器支持多任务，任务的创建需要分配内存空间；当任务终止后，还要回收它所占用的内存空间。为此IA-32 处理器支持分页功能，以简化内存管理。

为IA-32 处理器编程，访问内存时，需要在程序中给出段地址和偏移量，为IA-32 处理器编程，访问内存时，需要在程序中给出段地址和偏移量。如下图所示，当页功能开启时，段部件产生的地址就不再是物理地址了，而是线性地址

![分页](/images/assembly/ia_31_page.png)

IA-32 处理器上的每个任务都拥有4GB 的虚拟内存空间，这是一段长4GB 的平坦空间，就像一段平直的线段，因此叫线性地址空间。相应地，由段部件产生的地址，就对应着线性地址空间上的每一个点，这就是线性地址。
IA-32 架构下的任务、分段、分页等内容，是我们接下来要介绍的重点。