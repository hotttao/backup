---
title: 11. 任务和特权级保护
date: 2021-07-11
categories:
    - Go
tags:
	- x86 汇编
---

保护模式五
<!-- more -->

## 1. 内容概述
在保护模式下，通过将内存分成大小不等的段，并用描述符对每个段的用途、类型和长度进行指定，就可以在程序运行时由处理器硬件施加访问保护。段保护是处理器提供的基本保护功能，但对于现实的需求来说，仍是不够的。一个失控的程序，或者一个恶意的程序，依然可以通过追踪和修改描述符表来达到它们访问任何内存位置的目的。多任务系统，对任务之间的隔离和保护，以及任务和操作系统之间的隔离和保护都提出了要求，这可以看做对段保护机制的进一步强化。本章我们将介绍处理器的任务隔离和特权级，内容包括:
1. 任务的概念及其组成要素，包括任务的全局空间和局部空间、TSS、LDT、特权级等
2. 了解特别级不是指任务的特权级，而是指组成任务的各个部分的特权级。比如，任务的全局部分一般是0、1 和2 特权级别的，任务的私有部分一般是3 特权级别的
3. 理解CPL、DPL 和RPL 的含义，以及不同特权级别之间的控制转移规则
4. 熟悉调用门的用法

## 2. 任务
### 2.1 任务、任务的LDT 和TSS
![多任务系统的组成示意图](/images/assembly/task.png)

运行中的程序称为一个任务，如上图所示，为了有效地在任务之间实施隔离，处理器建议每个任务都应当具有自己的描述符表，称为**局部描述符表LDT（Local Descriptor Table）**，并且把专属于自己的那些段放到LDT 中。

每个任务都有自己的LDT，每个任务私有的段，都应当在LDT 中进行描述。另外，LDT 的第1 个描述符，也就是0 号槽位，也是有效的、可以使用的。为了追踪和访问这些LDT，处理器使用了局部描述符表寄存器（LDT Register：LDTR）。因为LDTR 寄存器只有一个，所以，它只用于指向当前任务的LDT。每当发生任务切换时，LDTR 的内容被更新，以指向新任务的LDT。

段选择子的位2 是表指示器（Table Indicator：TI），若TI＝0，表示从GDT 中加载描述符；TI＝1，表示从当前任务的LDT 中加载描述符。

在一个多任务的环境中，当任务切换发生时，必须保护旧任务的运行状态，以便在下次重新执行时恢复它们。为了保存任务的状态，每个任务都应当用一个额外的内存区域保存相关信息，这叫做**任务状态段（Task State Segment：TSS）**

#### TSS 格式
![TSS 格式](/images/assembly/tss.png)

如图所示，任务状态段TSS 具有固定的格式，最小尺寸是104 字节，图中所标注的偏移量是十进制的。处理器固件能够识别TSS 中的每个元素，并在任务切换的时候读取其中的信息。和LDT 一样，处理器用**TR 寄存器（Task Register：TR）**来指向当前任务的TSS。和GDTR、LDTR 一样，TR 寄存器在处理器中也只有一个。当任务切换发生的时候，TR 寄存器的内容也会跟着指向新任务的TSS。

任务切换时，处理器将当前任务的现场信息保存到由TR 寄存器指向的TSS；然后，再使TR 寄存器指向新任务的TSS，并从新任务的TSS 中恢复现场。

### 2.2 全局空间和局部空间
每个任务实际上包括两个部分：全局部分和私有部分。全局部分是所有任务共有的，含有操作系统的软件和库程序，以及可以调用的系统服务和数据；私有部分则是每个任务各自的数据和代码，与任务所要解决的具体问题有关，彼此并不相同。

任务实际上是在内存中运行的，所以，所谓的全局部分和私有部分，其实是地址空间的划分，即全局地址空间和局部地址空间，简称全局空间和局部空间。地址空间的访问是依靠分段机制来进行的。

具体地说，需要先在描述符表中定义各个段的描述符，然后再通过描述符来访问它们。因此，全局地址空间是用全局描述符表（GDT）来指定的，而局部地址空间则是由每个任务私有的局部描述符表（LDT）来定义的。

从程序员的角度来看，任务的全局空间包含了操作系统的段，是由别人编写的，但是他可以调用这些段的代码，或者获取这些段中的数据；任务局部空间的内容是由程序员自己创建的。通常，任务会在自己的局部空间运行，当它需要操作系统提供的服务时，转入全局空间执行。

### 2.3 特权级
引入LDT 和TSS，只是从任务层面上进一步强化了分段机制，从安全保障的角度来看，只相当于构建了可靠的硬件设施。当然，仅有设施是不够的，还需要规章制度，还要有人来执行，处理器也一样。为此，**在分段机制的基础上，处理器引入了特权级**，并由固件负责实施特权级保护。

特权级（Privilege Level），也叫特权级别，是存在于**描述符及其选择子**中的一个数值。Intel 处理器可以识别4 个特权级别，分别是0 到3，较大的数值意味着较低的特权级别，如图所示，是Intel 处理器所提供的4 级环状保护结构。

![处理器的4 级环状保护结构](/images/assembly/privilege.png)

1. 特权级0是操作系统内核
2. 特权级1、2是系统服务程序，包括设备驱动程序
3. 特权级3是应用程序

实施特权级保护的第一步，是为所有可管理的对象赋予一个特权级，以决定谁能访问它们。每个描述符都有一个两比特的DPL 字段是**描述符特权级（Descriptor Privilege Level）**。描述符总是指向它所描述的目标对象，代表着该对象，因此，该字段实际上是目标对象的特权级。
1. 对于数据段来说，DPL 决定了访问它们所应当具备的最低特权级别。
2. 当处理器正在一个代码段中取指令和执行指令时，那个代码段的特权级叫做当前特权级（Current Privilege Level，CPL）。正在执行的这个代码段，其选择子位于段寄存器CS 中，其最低两位就是当前特权级的数值。

